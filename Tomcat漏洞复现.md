## Tomcat漏洞复现

### tomcat 弱口令Getshell

#### 漏洞描述

```php
  Tomcat是Apache 软件基金会（Apache Software Foundation）的Jakarta 项目中的一个核心项目，由Apache、Sun 和其他一些公司及个人共同开发而成。 通过弱口令登录后台，部署war包geshell
```



#### 影响版本

```php
tomcat 全版本
```

WW

#### 环境搭建

```php
vulfocus tomcat-pass-getshell 弱口令
```



#### 复现过程

1、打开tomcat管理页面 http://ip/manager/html，就是我们正常访问tomcat页面：

![image-20220107104257133](image/tomcat/image-20220107104257133.png)

2、输入弱口令tomcat/tomcat成功登录到后台

![image-20220107104406190](image/tomcat/image-20220107104406190.png)

3、将jsp Webshell压缩为zip，再将zip后缀改名为war，然后tomcat页面上上传war包

![image-20220107104638478](image/tomcat/image-20220107104638478.png)

![image-20220107104657962](image/tomcat/image-20220107104657962.png)

4、上传成功后会在管理页面上显示，接下来用蚁剑去连接

![image-20220107104806151](image/tomcat/image-20220107104806151.png)

链接地址：http://ip/shell/shell.jsp

![image-20220107104841863](image/tomcat/image-20220107104841863.png)



#### 漏洞修复

1）在系统上以低权限运行Tomcat应用程序。创建一个专门的 Tomcat服务用户，该用户只能拥有一组最小权限（例如不允许远程登录）。

2）增加对于本地和基于证书的身份验证，部署账户锁定机制（对于集中式认证，目录服务也要做相应配置）。在CATALINA_HOME/conf/web.xml文件设置锁定机制和时间超时限制。

3）以及针对manager-gui/manager-status/manager-script等目录页面设置最小权限访问限制。

4）后台管理避免弱口令。



###  tomcat 文件上传 (CVE-2017-12615)

#### 漏洞简述

```php
	2017年9月19日，Apache Tomcat 官方确认并修复了两个高危漏洞，漏洞 CVE 编号:CVE-2017-12615 和 CVE-2017-12616,该漏洞受影响版本为7.0-7.80之间，官方评级为高危，在一定条件下，攻击者可以利用这两个漏洞，获取用户服务器上 JSP 文件的源代码，或是通过精心构造的攻击请求，向用户服务器上传恶意 JSP 文件，通过上传的 JSP 文件 ，可在用户服务器上执行任意代码，从而导致数据泄露或获取服务器权限，存在高安全风险。
```



#### 漏洞编号

```php
CVE-2017-12615
```



#### 影响版本

```php
Apache Tomcat 7.0.0 - 7.0.79 (windows环境)
Apache Tomcat 7.0.0 - 7.0.80
```



#### 利用条件

- CVE-2017-12615 漏洞利用需要在 Windows 环境，且需要将 readonly 初始化参数由默认值设置为 false，经过实际测试，Tomcat 7.x 版本内 web.xml 配置文件内默认配置无 readonly 参数，需要手工添加，默认配置条件下不受此漏洞影响。
- CVE-2017-12616 漏洞需要在 server.xml 文件配置 VirtualDirContext 参数，经过实际测试，Tomcat 7.x 版本内默认配置无 VirtualDirContext 参数，需要手工添加，默认配置条件下不受此漏洞影响。



#### 环境搭建

```php
vulfocus tomcat 文件上传 (CVE-2017-12615)
```



#### 复现过程

1、第一种方式：通过curl发送PUT请求包进行文件上传

```
curl -X PUT "http://192.168.22.1:55358/1.jsp/" -d '<%out.println("hello world!");%>'
```

![image-20220107110705748](image/tomcat/image-20220107110705748.png)

2、第二种方式：通过burpsuite发送数据包上传

![image-20220107111421875](image/tomcat/image-20220107111421875.png)

![image-20220107111429716](image/tomcat/image-20220107111429716.png)



#### 漏洞修复

1、 PUT默认是关闭的。如果开启了，可将conf/web.xml 中对于 DefaultServlet 的 readonly 设置为 true，才能防止漏洞。
2、升级到稳定版本。



### tomcat AJP 任意文件读取/包含漏洞（CVE-2020-1938）

#### 漏洞简述

```php
	Tomcat 是一个小型的轻量级应用服务器，在中小型系统和并发访问用户不是很多的场合下被普遍使用，是开发和调试JSP 程序的首选。 该漏洞是由于Tomcat AJP协议存在缺陷而导致，攻击者利用该漏洞可通过构造特定参数，读取服务器webapp下的任意文件。若目标服务器同时存在文件上传功能，攻击者可进一步实现远程代码执行。
```



#### 影响版本

- Apache Tomcat 6
- 7 <= Apache Tomcat < 7.0.100
- 8 <= Apache Tomcat < 8.5.51
- 9 <= Apache Tomcat < 9.0.31



#### 环境搭建

```php
vulfocus tomcat 代码执行 (CVE-2020-1938)
```



#### 复现过程

1、扫描目标开放端口，开启了两个端口8080（tomcat服务）和8009（AJP服务）

```
nmap -p- -sV 172.17.0.3
```

![image-20220107112419356](image/tomcat/image-20220107112419356.png)

2、访问目标主机8080端口，页面显示找不到页面，但从返回信息中得到了目标运行的tomcat版本为7.0.57

![image-20220107112654949](image/tomcat/image-20220107112654949.png)

3、下载exp脚本进行攻击

下载地址：https://github.com/YDHCUI/CNVD-2020-10487-Tomcat-Ajp-lfi

![image-20220107113614249](image/tomcat/image-20220107113614249.png)



![image-20220107112608437](image/tomcat/image-20220107112608437.png)

![image-20220107112643696](image/tomcat/image-20220107112643696.png)

#### 漏洞修复

（1）临时禁用AJP协议端口，在conf/server.xml配置文件中注释掉：<Connector port="8009" protocol="AJP/1.3"redirectPort="8443" />

（2）配置ajp配置中的secretRequired跟secret属性来限制认证

（3）下载更新版本。



